<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#0a0a0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FlyAndEarn">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=yes">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/icons/icon.svg">
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png">
    <title>Dashboard | FlyAndEarn - Manage Your Duty-Free Deals</title>
    <meta name="description" content="Manage your duty-free requests, trips, and deals. Track earnings, view wallet balance, and connect with travelers on FlyAndEarn.">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="content-language" content="en, pl, fr, de">
    <link rel="canonical" href="https://flyandearn.eu/dashboard">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta property="og:title" content="Dashboard | FlyAndEarn">
    <meta property="og:description" content="Manage your duty-free requests, trips, and deals on FlyAndEarn.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://flyandearn.eu/dashboard">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="leaflet.min.css">
    <script src="i18n.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-card: #18181b;
            --border: #27272a;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #a1a1aa;
            --accent-gold: #d4a853;
            --accent-gold-light: #f0d78c;
            --accent-teal: #2dd4bf;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        
        .app-layout { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; }
        .sidebar-logo { display: flex; align-items: center; gap: 0.75rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; text-decoration: none; }
        .sidebar-logo span { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
        .fly { color: var(--text-primary); }
        .amp { color: var(--accent-gold); }
        .earn { color: var(--accent-teal); }
        
        .nav-section { margin-bottom: 1.5rem; }
        .nav-section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem; padding-left: 0.75rem; }
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 8px; color: var(--text-secondary); text-decoration: none; transition: all 0.2s; margin-bottom: 0.25rem; }
        .nav-link:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-link.active { background: rgba(212, 168, 83, 0.1); color: var(--accent-gold); }
        .nav-link-icon { font-size: 1.25rem; width: 24px; text-align: center; }
        .nav-link-badge { margin-left: auto; background: var(--accent-gold); color: #000; font-size: 0.7rem; font-weight: 600; padding: 0.125rem 0.5rem; border-radius: 10px; }
        
        .sidebar-user { padding-top: 1rem; border-top: 1px solid var(--border); margin-top: auto; }
        
        /* Language buttons */
        .lang-btn { width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); cursor: pointer; font-size: 1.1rem; transition: all 0.2s; }
        .lang-btn:hover { border-color: var(--accent-gold); transform: scale(1.1); }
        .lang-btn.active { border-color: var(--accent-gold); background: rgba(212, 168, 83, 0.1); }
        
        /* Language Dropdown */
        .lang-dropdown { position: relative; }
        .lang-dropdown-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-light)); border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(212, 168, 83, 0.3); }
        .lang-dropdown-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 168, 83, 0.5); }
        .lang-dropdown-btn .arrow { font-size: 0.6rem; color: #000; }
        .lang-dropdown.open .arrow { transform: rotate(180deg); }
        .flag-img { width: 32px; height: 24px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .lang-dropdown-btn .flag-img { display: none; }
        .lang-dropdown-menu { position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: var(--bg-card); border: 2px solid var(--accent-gold); border-radius: 12px; overflow: hidden; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .lang-dropdown.open .lang-dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .lang-option { display: flex; align-items: center; justify-content: center; padding: 0.625rem 0.75rem; cursor: pointer; transition: all 0.15s; border-bottom: 1px solid var(--border); }
        .lang-option:last-child { border-bottom: none; }
        .lang-option:hover { background: rgba(212, 168, 83, 0.15); }
        .lang-option:hover .flag-img { transform: scale(1.1); }
        .lang-option.active { background: rgba(212, 168, 83, 0.25); }
        .user-card { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-card); border-radius: 10px; cursor: pointer; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-light)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: #000; }
        .user-info { flex: 1; }
        .user-name { font-weight: 600; font-size: 0.9rem; }
        .user-role { font-size: 0.75rem; color: var(--text-muted); }
        
        /* Main Content */
        .main-content { flex: 1; margin-left: 260px; padding: 2rem; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .page-title { font-size: 1.75rem; font-weight: 700; }
        .page-subtitle { color: var(--text-secondary); margin-top: 0.25rem; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; }
        .stat-card-icon { width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem; }
        .stat-card-value { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem; }
        .stat-card-label { font-size: 0.875rem; color: var(--text-muted); }
        
        /* Content Sections */
        .content-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; margin-bottom: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 1rem; }
        .section-title { font-size: 1.1rem; font-weight: 600; }
        .section-tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .tab-btn { padding: 0.5rem 1rem; border-radius: 6px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 0.875rem; }
        .tab-btn:hover { background: var(--bg-secondary); }
        .tab-btn.active { background: var(--accent-gold); color: #000; font-weight: 500; }
        .section-content { padding: 1.5rem; }
        
        /* Item Cards */
        .item-list { display: flex; flex-direction: column; gap: 1rem; }
        .item-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; flex-wrap: wrap; }
        .item-card:hover { border-color: var(--accent-gold); transform: translateY(-2px); }
        .item-icon { width: 48px; height: 48px; border-radius: 10px; background: var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .item-details { flex: 1; min-width: 150px; }
        .item-title { font-weight: 600; margin-bottom: 0.25rem; }
        .item-meta { font-size: 0.85rem; color: var(--text-muted); }
        .item-route { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.9rem; flex-wrap: wrap; }
        .item-route .arrow { color: var(--accent-gold); }
        .item-price { text-align: right; }
        .item-price-value { font-size: 1.1rem; font-weight: 600; color: var(--accent-gold); }
        .item-price-label { font-size: 0.75rem; color: var(--text-muted); }
        .item-status { padding: 0.375rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; white-space: nowrap; }
        .status-open { background: rgba(34, 197, 94, 0.1); color: var(--accent-green); }
        .status-matched { background: rgba(59, 130, 246, 0.1); color: var(--accent-blue); }
        .status-in_progress { background: rgba(212, 168, 83, 0.1); color: var(--accent-gold); }
        .status-completed { background: rgba(34, 197, 94, 0.1); color: var(--accent-green); }
        .status-pending_payment { background: rgba(239, 68, 68, 0.1); color: var(--accent-red); }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; font-size: 0.95rem; text-decoration: none; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-light)); color: #000; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(212, 168, 83, 0.3); }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-outline { background: transparent; color: var(--text-primary); border: 1px solid var(--border); }
        .btn-outline:hover { border-color: var(--accent-gold); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .btn:disabled, .btn[disabled] { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-loading { position: relative; color: transparent !important; }
        .btn-loading::after { content: ''; position: absolute; width: 16px; height: 16px; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 3rem; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .empty-state-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .empty-state-text { color: var(--text-muted); margin-bottom: 1.5rem; }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { display: flex; gap: 1rem; justify-content: flex-end; padding: 1rem 1.5rem; border-top: 1px solid var(--border); }
        
        /* Form */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .form-label .required { color: var(--accent-red); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.875rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem; font-family: inherit; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-gold); box-shadow: 0 0 0 3px rgba(212, 168, 83, 0.15); }
        .form-input.error, .form-select.error, .form-textarea.error { border-color: var(--accent-red); }
        .form-input.error:focus, .form-select.error:focus, .form-textarea.error:focus { box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15); }
        .form-error { font-size: 0.8rem; color: var(--accent-red); margin-top: 0.375rem; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.375rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-input:disabled, .form-select:disabled, .form-textarea:disabled { opacity: 0.6; cursor: not-allowed; background: var(--bg-card); }
        
        /* Toast */
        #toastContainer { position: fixed; bottom: 2rem; right: 2rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        .toast-success .toast-icon { color: var(--accent-green); }
        .toast-error .toast-icon { color: var(--accent-red); }
        .toast-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.25rem; }

        /* Leaflet Dark Theme */
        .leaflet-popup-content-wrapper { background: var(--bg-card); color: var(--text-primary); border-radius: 8px; }
        .leaflet-popup-tip { background: var(--bg-card); }
        .leaflet-popup-content { margin: 0.75rem 1rem; font-size: 0.875rem; }
        .leaflet-container { background: var(--bg-secondary); }
        @media (max-width: 900px) {
            #page-nearby-map > div:last-child { grid-template-columns: 1fr !important; }
            #nearbyMap { height: 350px !important; }
        }

        /* Deal breakdown */
        .deal-breakdown { background: var(--bg-secondary); border-radius: 8px; padding: 1rem; }
        .deal-breakdown-row { display: flex; justify-content: space-between; padding: 0.5rem 0; }
        .deal-breakdown-row:not(:last-child) { border-bottom: 1px solid var(--border); }
        .deal-breakdown-label { color: var(--text-muted); }
        .deal-breakdown-total { color: var(--accent-gold); font-weight: 700; }
        
        /* Mobile */
        .mobile-header { display: none; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .sidebar-overlay.show { display: block; }
        
        @media (max-width: 768px) {
            .sidebar { left: -100%; transition: left 0.3s; }
            .sidebar.show { left: 0; }
            .main-content { margin-left: 0; padding: 1rem; padding-top: 70px; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: fixed; top: 0; left: 0; right: 0; z-index: 50; }
            .mobile-menu-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; min-width: 44px; min-height: 44px; }
            .mobile-menu-btn:active { opacity: 0.7; }
            .form-row { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .verification-banner-content { flex-wrap: wrap; gap: 0.75rem; }
            .verification-banner-text { flex: 1 1 100%; }
            #toastContainer { bottom: 1rem; right: 1rem; left: 1rem; }
            .toast { padding: 0.875rem 1rem; }
            .modal { max-width: calc(100vw - 2rem); margin: 0.5rem; }
            .modal-body { padding: 1rem; }
            .modal-header, .modal-footer { padding: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
            .stat-card { padding: 1rem; }
            .stat-card-value { font-size: 1.4rem; }
        }

        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .item-card { padding: 0.875rem; }
            .item-details { min-width: 0; }
            .btn { padding: 0.625rem 1rem; font-size: 0.875rem; }
            .btn-sm { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
        }

        /* Welcome/Onboarding Panel */
        .welcome-panel { background: linear-gradient(135deg, rgba(212, 168, 83, 0.08), rgba(45, 212, 191, 0.05)); border: 1px solid rgba(212, 168, 83, 0.2); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; }
        .welcome-panel h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .welcome-panel > p { color: var(--text-secondary); margin-bottom: 1.5rem; }
        .onboarding-steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .onboarding-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .onboarding-card:hover { border-color: var(--accent-gold); transform: translateY(-2px); }
        .onboarding-card .step-number { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-light)); border-radius: 50%; color: #000; font-weight: 700; font-size: 0.85rem; margin-bottom: 0.75rem; }
        .onboarding-card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.35rem; }
        .onboarding-card p { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; }

        /* Email Verification Banner */
        .verification-banner {
            background: linear-gradient(135deg, rgba(212, 168, 83, 0.1), rgba(212, 168, 83, 0.05));
            border: 1px solid rgba(212, 168, 83, 0.3);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
        }
        .verification-banner-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .verification-banner-icon {
            font-size: 1.5rem;
        }
        .verification-banner-text {
            flex: 1;
        }
        .verification-banner-text strong {
            display: block;
            color: var(--accent-gold);
            margin-bottom: 0.25rem;
        }
        .verification-banner-text span {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .verification-banner-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem;
        }
        .verification-banner-close:hover {
            color: var(--text-primary);
        }
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.3s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent-gold);
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 2px rgba(212, 168, 83, 0.3);
        }

        /* Category Chips */
        .category-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .category-chip:hover {
            border-color: var(--accent-gold);
            color: var(--text-primary);
        }
        .category-chip input {
            display: none;
        }
        .category-chip:has(input:checked) {
            background: rgba(212, 168, 83, 0.15);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Outside Duty-Free Badge */
        .odf-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            background: linear-gradient(135deg, rgba(212, 168, 83, 0.2), rgba(45, 212, 191, 0.1));
            border: 1px solid var(--accent-gold);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--accent-gold);
            font-weight: 500;
        }
        .odf-badge-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent-gold);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease, background 0.2s ease;
        }
        .back-to-top:hover { background: #e5b963; }
        .back-to-top.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        .back-to-top:focus { outline: 3px solid var(--accent-teal); outline-offset: 3px; }
        .back-to-top svg { width: 24px; height: 24px; fill: #0a0a0b; }
        @media (prefers-reduced-motion: reduce) {
            .back-to-top { transition: none; }
        }
    </style>
</head>
<body>
    <!-- Skip to main content -->
    <a href="#page-dashboard" class="skip-link" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;z-index:10000;padding:1rem;background:var(--accent-gold);color:#000;text-decoration:none;font-weight:600;border-radius:0 0 8px 0;&:focus{position:fixed;left:0;top:0;width:auto;height:auto;}">Skip to main content</a>

    <!-- Mobile Header -->
    <div class="mobile-header" role="banner">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        <span><span class="fly">Fly</span><span class="amp">&</span><span class="earn">Earn</span></span>
        <div style="width: 24px;"></div>
    </div>

    <div class="app-layout">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar" role="complementary" aria-label="Dashboard sidebar">
            <a class='sidebar-logo' href='/'>
                <span><span class="fly">Fly</span><span class="amp">&</span><span class="earn">Earn</span></span>
            </a>

            <nav aria-label="Dashboard navigation">
                <div class="nav-section">
                    <div class="nav-section-title">Menu</div>
                    <a href="#dashboard" class="nav-link active" data-page="dashboard">
                        <span class="nav-link-icon">üìä</span> Dashboard
                    </a>
                    <a href="#browse" class="nav-link" data-page="browse">
                        <span class="nav-link-icon">üîç</span> Browse Requests
                        <span class="nav-link-badge" id="requestsCount">0</span>
                    </a>
                    <a href="#travelers" class="nav-link" data-page="travelers">
                        <span class="nav-link-icon">‚úàÔ∏è</span> Find Travelers
                    </a>
                    <a href="#nearby-map" class="nav-link" data-page="nearby-map">
                        <span class="nav-link-icon">üìç</span> Nearby Map
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">My Activity</div>
                    <a href="#my-requests" class="nav-link" data-page="my-requests">
                        <span class="nav-link-icon">üìã</span> My Requests
                    </a>
                    <a href="#my-trips" class="nav-link" data-page="my-trips">
                        <span class="nav-link-icon">üß≥</span> My Trips
                    </a>
                    <a href="#deals" class="nav-link" data-page="deals">
                        <span class="nav-link-icon">ü§ù</span> <span data-i18n="nav.myDeals">My Deals</span>
                    </a>
                    <a href="#messages" class="nav-link" data-page="messages">
                        <span class="nav-link-icon">üí¨</span> <span data-i18n="nav.messages">Messages</span>
                        <span class="nav-link-badge messages-badge" id="messagesCount" style="display: none;">0</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title" data-i18n="nav.settings">Account</div>
                    <a href="#subscription" class="nav-link" data-page="subscription">
                        <span class="nav-link-icon">‚≠ê</span> <span>Subscription</span>
                    </a>
                    <a class='nav-link' href='/wallet'>
                        <span class="nav-link-icon">üí∞</span> <span data-i18n="nav.wallet">Wallet</span>
                    </a>
                    <a href="#settings" class="nav-link" data-page="settings">
                        <span class="nav-link-icon">‚öôÔ∏è</span> <span data-i18n="nav.settings">Settings</span>
                    </a>
                </div>
                
                <!-- Language & Region Selector -->
                <div class="nav-section">
                    <div class="nav-section-title">Language & Region</div>
                    <div id="locale-selector-dashboard" style="padding: 0.5rem;"></div>
                </div>
            </nav>

            <div class="sidebar-user">
                <div class="user-card" id="userCard">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-info">
                        <div class="user-name" id="userName" data-i18n="auth.guest">Guest</div>
                        <div class="user-role" id="userRole" data-i18n="auth.clickToLogin">Click to login</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" role="main">
            <!-- Email Verification Banner -->
            <div id="emailVerificationBanner" class="verification-banner" style="display: none;">
                <div class="verification-banner-content">
                    <div class="verification-banner-icon">üìß</div>
                    <div class="verification-banner-text">
                        <strong>Verify your email address</strong>
                        <span>Please verify your email to access all features and secure your account.</span>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="sendVerificationEmail()">Send Verification Email</button>
                    <button class="verification-banner-close" onclick="dismissVerificationBanner()">√ó</button>
                </div>
            </div>

            <!-- Welcome/Onboarding Panel (shown for new users) -->
            <div class="welcome-panel" id="welcomePanel" style="display:none;">
                <h2>üëã Welcome to FlyAndEarn!</h2>
                <p>Here's how to get started:</p>
                <div class="onboarding-steps">
                    <div class="onboarding-card" onclick="showPage('settings')">
                        <span class="step-number">1</span>
                        <h3>Complete Your Profile</h3>
                        <p>Add your city and phone number for better matching</p>
                    </div>
                    <div class="onboarding-card" onclick="showModal('createTrip')">
                        <span class="step-number">2</span>
                        <h3>Post a Trip or Request</h3>
                        <p>Travelers: share your next flight. Buyers: tell us what you need.</p>
                    </div>
                    <div class="onboarding-card" onclick="showPage('browse')">
                        <span class="step-number">3</span>
                        <h3>Get Matched & Earn</h3>
                        <p>We'll connect you with the perfect match on your route.</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="page-dashboard" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Welcome back! Here's what's happening.</p>
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="showModal('createTrip')">+ Add Trip</button>
                        <button class="btn btn-primary" onclick="showModal('createRequest')">+ Create Request</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background: rgba(212, 168, 83, 0.1);">üí∞</div>
                        <div class="stat-card-value" id="statBalance">‚Ç¨0.00</div>
                        <div class="stat-card-label">Wallet Balance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background: rgba(34, 197, 94, 0.1);">üì¶</div>
                        <div class="stat-card-value" id="statDeals">0</div>
                        <div class="stat-card-label">Active Deals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background: rgba(59, 130, 246, 0.1);">‚úàÔ∏è</div>
                        <div class="stat-card-value" id="statTrips">0</div>
                        <div class="stat-card-label">Upcoming Trips</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background: rgba(45, 212, 191, 0.1);">‚≠ê</div>
                        <div class="stat-card-value" id="statRating">-</div>
                        <div class="stat-card-label">Your Rating</div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üî• Open Requests</h2>
                        <a href="#browse" class="btn btn-outline btn-sm" onclick="showPage('browse')">View All</a>
                    </div>
                    <div class="section-content" id="hotRequests"></div>
                </div>
            </div>

            <!-- Browse Requests Page -->
            <div id="page-browse" class="page" style="display:none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Browse Requests</h1>
                        <p class="page-subtitle">Find requests that match your trips</p>
                    </div>
                </div>
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-tabs" id="requestTabs">
                            <button class="tab-btn active" onclick="filterRequests('all')">All</button>
                            <button class="tab-btn" onclick="filterRequests('spirits')">ü•É Spirits</button>
                            <button class="tab-btn" onclick="filterRequests('perfume')">‚ú® Perfume</button>
                            <button class="tab-btn" onclick="filterRequests('electronics')">üì± Electronics</button>
                        </div>
                    </div>
                    <div class="section-content" id="requestsList"></div>
                </div>
            </div>

            <!-- My Requests Page -->
            <div id="page-my-requests" class="page" style="display:none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">My Requests</h1>
                        <p class="page-subtitle">Track your duty-free requests</p>
                    </div>
                    <button class="btn btn-primary" onclick="showModal('createRequest')">+ Create Request</button>
                </div>
                <div class="content-section">
                    <div class="section-content" id="myRequestsList"></div>
                </div>
            </div>

            <!-- My Trips Page -->
            <div id="page-my-trips" class="page" style="display:none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">My Trips</h1>
                        <p class="page-subtitle">Manage your upcoming trips</p>
                    </div>
                    <button class="btn btn-primary" onclick="showModal('createTrip')">+ Add Trip</button>
                </div>
                <div class="content-section">
                    <div class="section-content" id="myTripsList"></div>
                </div>
            </div>

            <!-- My Deals Page -->
            <div id="page-deals" class="page" style="display:none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">My Deals</h1>
                        <p class="page-subtitle">Track your active and completed deals</p>
                    </div>
                </div>
                <div class="content-section">
                    <div class="section-content" id="dealsList"></div>
                </div>
            </div>

            <!-- Messages Page -->
            <div id="page-messages" class="page" style="display:none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title" data-i18n="messages.title">Messages</h1>
                        <p class="page-subtitle" data-i18n="messages.subtitle">Chat with travelers and buyers</p>
                    </div>
                </div>
                <div class="content-section">
                    <div class="section-content" id="messagesContainer" style="min-height: 400px;">
                        <!-- Empty State -->
                        <div id="messagesEmptyState" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;" data-i18n="messages.noConversations">No conversations yet</p>
                            <p data-i18n="messages.startChat">Start by contacting a traveler on the homepage</p>
                        </div>
                        <!-- Conversations List -->
                        <div id="conversationsList" style="display: none;"></div>
                        <!-- Chat View -->
                        <div id="chatView" style="display: none;">
                            <div id="chatHeader" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 1rem;">
                                <button onclick="closeChatView()" style="background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; padding: 0.25rem;">‚Üê</button>
                                <div style="flex: 1;">
                                    <div id="chatWithName" style="font-weight: 600;"></div>
                                    <div id="chatTripRoute" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
                                </div>
                                <div id="chatStatusBadge" style="display: none; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;"></div>
                                <button id="markCompleteBtn" class="btn btn-primary" onclick="markTransactionComplete()" style="white-space: nowrap; display: none;">‚úì Mark Complete</button>
                            </div>
                            <div id="chatMessages" style="height: 400px; overflow-y: auto; padding: 1rem; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 0.75rem;"></div>
                            <div id="chatInputArea" style="display: flex; gap: 0.75rem;">
                                <input type="text" id="chatInput" class="form-input" placeholder="Type a message..." style="flex: 1;" onkeypress="if(event.key==='Enter')sendChatMessage()">
                                <button class="btn btn-primary" onclick="sendChatMessage()" style="white-space: nowrap;">Send</button>
                            </div>
                            <!-- Completed state actions -->
                            <div id="completedActions" style="display: none; text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 12px;">
                                <p style="color: var(--text-secondary); margin-bottom: 0.75rem;">Transaction completed!</p>
                                <button id="rateNowBtn" class="btn btn-primary" onclick="openRatingModal()" style="display: none;">‚≠ê Rate Now</button>
                                <span id="alreadyRated" style="display: none; color: var(--text-muted);">‚úì You have rated this transaction</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Find Travelers Page -->
            <div id="page-travelers" class="page" style="display:none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Find Travelers</h1>
                        <p class="page-subtitle">Browse upcoming trips from verified travelers</p>
                        <p style="font-size: 0.9rem; color: var(--accent-gold); font-style: italic; margin-top: 0.5rem;">üåç "Have a shopper at the end of the world for your purchases."</p>
                    </div>
                </div>

                <!-- Search Filters -->
                <div class="content-section" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                            <label class="form-label">Destination City</label>
                            <input type="text" class="form-input" id="travelerSearchDestination" placeholder="Search city..." onkeyup="debounceSearch()">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="travelerSearchOutsideDutyFree" onchange="searchTravelers()" style="width: auto;">
                                <span>üõçÔ∏è Outside duty-free shoppers only</span>
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="searchTravelers()">Search</button>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-content" id="travelersList"></div>
                </div>
            </div>

            <!-- Nearby Map Page -->
            <div id="page-nearby-map" class="page" style="display:none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">üìç Nearby Users</h1>
                        <p class="page-subtitle">Find travelers and buyers near your location</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary btn-sm" id="geocodeAddressBtn" onclick="geocodeMyAddress()">
                            üìç Update from Address
                        </button>
                        <button class="btn btn-primary btn-sm" id="useBrowserLocationBtn" onclick="useBrowserLocation()">
                            üåê Use My Location
                        </button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 320px; gap: 1.5rem;">
                    <!-- Map -->
                    <div class="content-section" style="margin-bottom: 0;">
                        <div id="nearbyMap" style="height: 500px; border-radius: 12px;"></div>
                    </div>

                    <!-- Sidebar -->
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- Filters -->
                        <div class="content-section" style="margin-bottom: 0;">
                            <div class="section-header">
                                <h2 class="section-title">Filters</h2>
                            </div>
                            <div class="section-content">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label class="form-label">Distance Radius</label>
                                    <select id="mapRadiusSelect" class="form-select" onchange="updateMapRadius()">
                                        <option value="5">5 km</option>
                                        <option value="10">10 km</option>
                                        <option value="25" selected>25 km</option>
                                        <option value="50">50 km</option>
                                        <option value="100">100 km</option>
                                    </select>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="showAllUsers" onchange="toggleShowAll()">
                                    <label for="showAllUsers" style="font-size: 0.875rem; color: var(--text-secondary);">Show all users</label>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="content-section" style="margin-bottom: 0;">
                            <div class="section-content" style="padding: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                                    <span style="color: var(--text-muted); font-size: 0.875rem;">Nearby matches:</span>
                                    <span style="font-weight: 600; color: var(--accent-gold);" id="nearbyMatchCount">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted); font-size: 0.875rem;">Total users:</span>
                                    <span style="font-weight: 600; color: var(--accent-gold);" id="totalUserCount">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Legend -->
                        <div class="content-section" style="margin-bottom: 0;">
                            <div class="section-header">
                                <h2 class="section-title">Legend</h2>
                            </div>
                            <div class="section-content" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--accent-red); border: 2px solid white;"></span>
                                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Your location</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b; border: 2px solid white;"></span>
                                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Nearby matches</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--accent-blue); border: 2px solid white;"></span>
                                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Travelers</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--accent-green); border: 2px solid white;"></span>
                                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Buyers</span>
                                </div>
                            </div>
                        </div>

                        <!-- Nearby List -->
                        <div class="content-section" style="margin-bottom: 0; flex: 1;" id="nearbyListSection">
                            <div class="section-header">
                                <h2 class="section-title" id="nearbyListTitle">Nearby Users</h2>
                            </div>
                            <div class="section-content" id="nearbyUsersList" style="max-height: 250px; overflow-y: auto;">
                                <div class="empty-state" style="padding: 1rem;">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìç</div>
                                    <p style="font-size: 0.875rem; color: var(--text-muted);">Update your location to find nearby users</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscription Page -->
            <div id="page-subscription" class="page" style="display:none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Subscription</h1>
                        <p class="page-subtitle">Manage your subscription plan</p>
                    </div>
                </div>

                <!-- Current subscription status -->
                <div class="content-section" id="subscriptionStatusSection">
                    <div class="section-header">
                        <h2 class="section-title">Current Plan</h2>
                    </div>
                    <div class="section-content" id="subscriptionStatus">
                        <div class="empty-state">
                            <div class="empty-state-icon">&#128269;</div>
                            <div class="empty-state-title">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Available plans -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">Available Plans</h2>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                            <!-- Silver -->
                            <div class="subscription-plan-card" data-tier="SILVER" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">&#127775;</div>
                                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Silver</h3>
                                <p style="color: var(--text-muted); margin-bottom: 1rem;">Perfect for occasional travelers</p>
                                <div style="margin-bottom: 1rem;">
                                    <span style="font-size: 2rem; font-weight: 700;" class="plan-price">19.99</span>
                                    <span style="color: var(--text-muted);" class="plan-currency">PLN</span>
                                    <span style="color: var(--text-muted);">/year</span>
                                </div>
                                <div style="background: rgba(212, 168, 83, 0.1); color: var(--accent-gold); padding: 0.5rem 1rem; border-radius: 8px; display: inline-block; margin-bottom: 1rem;">Up to 5 purchases</div>
                                <ul style="list-style: none; margin-bottom: 1.5rem;">
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> 5 purchases per year</li>
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> Standard support</li>
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> Basic tracking</li>
                                </ul>
                                <button class="btn btn-outline subscribe-plan-btn" data-tier="SILVER" style="width: 100%;">Select Silver</button>
                            </div>
                            <!-- Gold -->
                            <div class="subscription-plan-card" data-tier="GOLD" style="background: var(--bg-secondary); border: 2px solid var(--accent-gold); border-radius: 16px; padding: 1.5rem; position: relative;">
                                <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--accent-gold); color: #000; padding: 0.25rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">MOST POPULAR</div>
                                <div style="font-size: 2rem; margin-bottom: 1rem;">&#11088;</div>
                                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Gold</h3>
                                <p style="color: var(--text-muted); margin-bottom: 1rem;">For regular travelers</p>
                                <div style="margin-bottom: 1rem;">
                                    <span style="font-size: 2rem; font-weight: 700;" class="plan-price">29.99</span>
                                    <span style="color: var(--text-muted);" class="plan-currency">PLN</span>
                                    <span style="color: var(--text-muted);">/year</span>
                                </div>
                                <div style="background: rgba(212, 168, 83, 0.1); color: var(--accent-gold); padding: 0.5rem 1rem; border-radius: 8px; display: inline-block; margin-bottom: 1rem;">Up to 10 purchases</div>
                                <ul style="list-style: none; margin-bottom: 1.5rem;">
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> 10 purchases per year</li>
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> Priority support</li>
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> Advanced tracking</li>
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> Early access to deals</li>
                                </ul>
                                <button class="btn btn-primary subscribe-plan-btn" data-tier="GOLD" style="width: 100%;">Select Gold</button>
                            </div>
                            <!-- Platinum -->
                            <div class="subscription-plan-card" data-tier="PLATINUM" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">&#128142;</div>
                                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Platinum</h3>
                                <p style="color: var(--text-muted); margin-bottom: 1rem;">For power users</p>
                                <div style="margin-bottom: 1rem;">
                                    <span style="font-size: 2rem; font-weight: 700;" class="plan-price">49.99</span>
                                    <span style="color: var(--text-muted);" class="plan-currency">PLN</span>
                                    <span style="color: var(--text-muted);">/year</span>
                                </div>
                                <div style="background: rgba(212, 168, 83, 0.1); color: var(--accent-gold); padding: 0.5rem 1rem; border-radius: 8px; display: inline-block; margin-bottom: 1rem;">Unlimited purchases</div>
                                <ul style="list-style: none; margin-bottom: 1.5rem;">
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> Unlimited purchases</li>
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> VIP support</li>
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> Premium tracking</li>
                                    <li style="padding: 0.5rem 0; color: var(--text-secondary);"><span style="color: var(--accent-teal);">&#10003;</span> Exclusive deals</li>
                                </ul>
                                <button class="btn btn-outline subscribe-plan-btn" data-tier="PLATINUM" style="width: 100%;">Select Platinum</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="page-settings" class="page" style="display:none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Settings</h1>
                        <p class="page-subtitle">Manage your account</p>
                    </div>
                </div>
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">Profile Information</h2>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label class="form-label">Display Name</label>
                            <input type="text" class="form-input" id="settingsName" placeholder="Your name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="settingsEmail" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">City</label>
                            <input type="text" class="form-input" id="settingsCity" placeholder="e.g., Warsaw">
                        </div>
                        <div class="form-group">
                            <label class="form-label">My Roles</label>
                            <div class="form-hint" style="margin-bottom: 0.75rem;">Select how you want to use FlyAndEarn. You can be both!</div>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="roleBuyerLabel">
                                    <input type="checkbox" id="settingsIsBuyer" onchange="updateRoleStyle()" style="width: 18px; height: 18px; accent-color: var(--accent-gold);">
                                    <span style="font-size: 1.25rem;">üõí</span>
                                    <div>
                                        <div style="font-weight: 600;">Buyer / Requestor</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">Request items from travelers</div>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="roleTravelerLabel">
                                    <input type="checkbox" id="settingsIsTraveler" onchange="updateRoleStyle()" style="width: 18px; height: 18px; accent-color: var(--accent-gold);">
                                    <span style="font-size: 1.25rem;">‚úàÔ∏è</span>
                                    <div>
                                        <div style="font-weight: 600;">Traveler</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">Fulfill requests and earn money</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Country</label>
                            <select class="form-input" id="settingsCountry" onchange="handleSettingsCountryChange()">
                                <option value="">Select your country</option>
                                <option value="Afghanistan">Afghanistan</option>
                                <option value="Albania">Albania</option>
                                <option value="Algeria">Algeria</option>
                                <option value="Andorra">Andorra</option>
                                <option value="Angola">Angola</option>
                                <option value="Argentina">Argentina</option>
                                <option value="Armenia">Armenia</option>
                                <option value="Australia">Australia</option>
                                <option value="Austria">Austria (EUR)</option>
                                <option value="Azerbaijan">Azerbaijan</option>
                                <option value="Bahrain">Bahrain</option>
                                <option value="Bangladesh">Bangladesh</option>
                                <option value="Belarus">Belarus</option>
                                <option value="Belgium">Belgium (EUR)</option>
                                <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                                <option value="Brazil">Brazil</option>
                                <option value="Bulgaria">Bulgaria</option>
                                <option value="Cambodia">Cambodia</option>
                                <option value="Canada">Canada</option>
                                <option value="Chile">Chile</option>
                                <option value="China">China</option>
                                <option value="Colombia">Colombia</option>
                                <option value="Croatia">Croatia (EUR)</option>
                                <option value="Cyprus">Cyprus (EUR)</option>
                                <option value="Czech Republic">Czech Republic</option>
                                <option value="Denmark">Denmark</option>
                                <option value="Egypt">Egypt</option>
                                <option value="Estonia">Estonia (EUR)</option>
                                <option value="Finland">Finland (EUR)</option>
                                <option value="France">France (EUR)</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Germany">Germany (EUR)</option>
                                <option value="Greece">Greece (EUR)</option>
                                <option value="Hong Kong">Hong Kong</option>
                                <option value="Hungary">Hungary</option>
                                <option value="Iceland">Iceland</option>
                                <option value="India">India</option>
                                <option value="Indonesia">Indonesia</option>
                                <option value="Ireland">Ireland (EUR)</option>
                                <option value="Israel">Israel</option>
                                <option value="Italy">Italy (EUR)</option>
                                <option value="Japan">Japan</option>
                                <option value="Jordan">Jordan</option>
                                <option value="Kazakhstan">Kazakhstan</option>
                                <option value="Kenya">Kenya</option>
                                <option value="Kuwait">Kuwait</option>
                                <option value="Latvia">Latvia (EUR)</option>
                                <option value="Lebanon">Lebanon</option>
                                <option value="Lithuania">Lithuania (EUR)</option>
                                <option value="Luxembourg">Luxembourg (EUR)</option>
                                <option value="Malaysia">Malaysia</option>
                                <option value="Malta">Malta (EUR)</option>
                                <option value="Mexico">Mexico</option>
                                <option value="Moldova">Moldova</option>
                                <option value="Monaco">Monaco (EUR)</option>
                                <option value="Montenegro">Montenegro (EUR)</option>
                                <option value="Morocco">Morocco</option>
                                <option value="Netherlands">Netherlands (EUR)</option>
                                <option value="New Zealand">New Zealand</option>
                                <option value="Nigeria">Nigeria</option>
                                <option value="North Macedonia">North Macedonia</option>
                                <option value="Norway">Norway</option>
                                <option value="Oman">Oman</option>
                                <option value="Pakistan">Pakistan</option>
                                <option value="Peru">Peru</option>
                                <option value="Philippines">Philippines</option>
                                <option value="Poland">Poland (PLN)</option>
                                <option value="Portugal">Portugal (EUR)</option>
                                <option value="Qatar">Qatar</option>
                                <option value="Romania">Romania</option>
                                <option value="Russia">Russia</option>
                                <option value="Saudi Arabia">Saudi Arabia</option>
                                <option value="Serbia">Serbia</option>
                                <option value="Singapore">Singapore</option>
                                <option value="Slovakia">Slovakia (EUR)</option>
                                <option value="Slovenia">Slovenia (EUR)</option>
                                <option value="South Africa">South Africa</option>
                                <option value="South Korea">South Korea</option>
                                <option value="Spain">Spain (EUR)</option>
                                <option value="Sweden">Sweden</option>
                                <option value="Switzerland">Switzerland</option>
                                <option value="Taiwan">Taiwan</option>
                                <option value="Thailand">Thailand</option>
                                <option value="Tunisia">Tunisia</option>
                                <option value="Turkey">Turkey</option>
                                <option value="Ukraine">Ukraine</option>
                                <option value="United Arab Emirates">United Arab Emirates</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="United States">United States</option>
                                <option value="Vietnam">Vietnam</option>
                            </select>
                            <div id="settingsCurrencyNotice" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--accent-gold); display: none;"></div>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
                        <button class="btn btn-outline" style="margin-left: 1rem;" onclick="logout()">Log Out</button>
                    </div>
                </div>

                <!-- GDPR Data Management -->
                <div class="content-section" style="margin-top: 2rem;">
                    <div class="section-header">
                        <h2 class="section-title">Data & Privacy (GDPR)</h2>
                    </div>
                    <div class="section-content">
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Under GDPR, you have the right to access, export, and delete your personal data.
                            Learn more in our <a href='/privacy' style='color: var(--accent-gold);'>Privacy Policy</a>.
                        </p>

                        <!-- Export Data -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;" data-i18n="settings.exportData">Export My Data</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);" data-i18n="settings.exportDataDesc">Download all your personal data in JSON format</div>
                            </div>
                            <button class="btn btn-secondary" onclick="exportUserData()">
                                <span>üì•</span> Export
                            </button>
                        </div>

                        <!-- Delete Account -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem; color: var(--accent-red);" data-i18n="settings.deleteAccount">Delete Account</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);" data-i18n="settings.deleteAccountDesc">Permanently delete your account and all associated data</div>
                            </div>
                            <button class="btn" style="background: var(--accent-red); color: #fff;" onclick="confirmDeleteAccount()">
                                <span>üóëÔ∏è</span> Delete
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Legal Links -->
                <div class="content-section" style="margin-top: 2rem;">
                    <div class="section-header">
                        <h2 class="section-title">Legal</h2>
                    </div>
                    <div class="section-content">
                        <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                            <a href='/privacy' style='color: var(--accent-gold); text-decoration: none;'>Privacy Policy</a>
                            <a href='/terms' style='color: var(--accent-gold); text-decoration: none;'>Terms of Service</a>
                            <a href="mailto:privacy@tropos.pl" style="color: var(--accent-gold); text-decoration: none;">Contact DPO</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Request Modal - Enhanced with Multi-Item Support -->
    <div class="modal-overlay" id="modal-createRequest">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Create a Request</h3>
                <button class="modal-close" onclick="hideModal('createRequest')">√ó</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Step 1: Request Type Selection -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" style="font-size: 1.1rem; margin-bottom: 0.75rem;">What do you want to buy? <span class="required">*</span></label>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <label class="request-type-option" id="reqTypeDF" onclick="selectRequestType('DUTY_FREE')">
                            <input type="radio" name="requestType" value="DUTY_FREE" checked style="display: none;">
                            <div class="request-type-card" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border: 2px solid var(--accent-gold); border-radius: 8px; cursor: pointer;">
                                <span style="font-size: 2rem;">‚úàÔ∏è</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">Duty-Free Items</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">Items from airport duty-free shops (15% service fee)</div>
                                </div>
                            </div>
                        </label>
                        <label class="request-type-option" id="reqTypeODF" onclick="selectRequestType('OUTSIDE_DUTY_FREE')">
                            <input type="radio" name="requestType" value="OUTSIDE_DUTY_FREE" style="display: none;">
                            <div class="request-type-card" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border: 2px solid transparent; border-radius: 8px; cursor: pointer;">
                                <span style="font-size: 2rem;">üõçÔ∏è</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">Items Outside Duty-Free</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">Any store, brand, online, or marketplace (20% service fee)</div>
                                </div>
                            </div>
                        </label>
                        <label class="request-type-option" id="reqTypeBoth" onclick="selectRequestType('BOTH')">
                            <input type="radio" name="requestType" value="BOTH" style="display: none;">
                            <div class="request-type-card" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border: 2px solid transparent; border-radius: 8px; cursor: pointer;">
                                <span style="font-size: 2rem;">üì¶</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">Both Types</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">Mix of duty-free and regular store items</div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Customs/Tax Notice for Outside Duty-Free -->
                <div id="customsNotice" style="display: none; padding: 0.75rem 1rem; background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                        <span>‚ö†Ô∏è</span>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            <strong>Note:</strong> Items purchased outside duty-free may be subject to customs duties and taxes in your country. The traveler will purchase at local retail prices.
                        </div>
                    </div>
                </div>

                <!-- Outside Duty-Free Store Preferences (shown when request type is OUTSIDE_DUTY_FREE or BOTH) -->
                <div id="outsideDutyFreePrefs" style="display: none; background: linear-gradient(135deg, rgba(212, 168, 83, 0.1), rgba(45, 212, 191, 0.05)); border: 1px solid var(--accent-gold); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <p style="font-size: 1rem; color: var(--accent-gold); margin: 0 0 1rem 0; font-style: italic; text-align: center;">üåç "Have a shopper at the end of the world for your purchases."</p>

                    <div class="form-row" style="gap: 1rem;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Store Type Preference</label>
                            <select class="form-input" id="reqStoreType">
                                <option value="any">Any store is fine</option>
                                <option value="brand_store">Brand/Official store</option>
                                <option value="mall">Shopping mall</option>
                                <option value="supermarket">Supermarket</option>
                                <option value="pharmacy">Pharmacy</option>
                                <option value="electronics">Electronics retailer</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Item Flexibility</label>
                            <select class="form-input" id="reqItemFlexibility">
                                <option value="exact_item">Exact item only</option>
                                <option value="acceptable_alternatives">Acceptable alternatives OK</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Purchase & Pickup Location -->
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <!-- Buy From Section -->
                    <div style="margin-bottom: 1.25rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.25rem;">üõí</span>
                            <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-primary);">Where should the traveler buy from?</h4>
                        </div>
                        <div class="form-hint" style="margin-bottom: 0.75rem; font-size: 0.85rem;">The airport/city where the traveler will purchase your items</div>
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Airport Code <span class="required">*</span></label>
                                <input type="text" class="form-input" id="reqFromAirport" placeholder="DXB" style="text-transform: uppercase;" maxlength="4">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">City / Country</label>
                                <input type="text" class="form-input" id="reqFromCity" placeholder="Dubai, UAE">
                            </div>
                        </div>
                    </div>

                    <!-- Visual Arrow -->
                    <div style="display: flex; justify-content: center; margin: 0.5rem 0;">
                        <div style="display: flex; flex-direction: column; align-items: center; color: var(--accent-gold);">
                            <span style="font-size: 1.5rem;">‚Üì</span>
                            <span style="font-size: 0.75rem; color: var(--text-muted);">Traveler brings items</span>
                        </div>
                    </div>

                    <!-- Pick Up Section -->
                    <div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.25rem;">üìç</span>
                            <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-primary);">Where will you pick up?</h4>
                        </div>
                        <div class="form-hint" style="margin-bottom: 0.75rem; font-size: 0.85rem;">The airport/city where you'll collect your items from the traveler</div>
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Airport Code <span class="required">*</span></label>
                                <input type="text" class="form-input" id="reqToAirport" placeholder="WAW" style="text-transform: uppercase;" maxlength="4">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">City / Country</label>
                                <input type="text" class="form-input" id="reqToCity" placeholder="Warsaw, Poland">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Items List -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-muted);">Items to Purchase</h4>
                        <button type="button" class="btn btn-secondary" onclick="addRequestItem()" style="padding: 0.4rem 0.75rem; font-size: 0.85rem;">+ Add Item</button>
                    </div>
                    <div id="requestItemsList">
                        <!-- Items will be added here dynamically -->
                    </div>
                </div>

                <!-- Step 4: Additional Info -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Needed By</label>
                        <input type="date" class="form-input" id="reqNeededBy">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select class="form-select" id="reqCurrency">
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="PLN">PLN (z≈Ç)</option>
                            <option value="USD">USD ($)</option>
                            <option value="GBP">GBP (¬£)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">General Notes for Traveler</label>
                    <textarea class="form-input" id="reqGeneralNotes" rows="2" placeholder="Any additional instructions or preferences..."></textarea>
                </div>

                <!-- Maximum Price Section -->
                <div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05)); border: 2px solid var(--accent-gold); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <span style="font-size: 1.25rem;">üí∞</span>
                        <h4 style="margin: 0; font-size: 1rem; color: var(--text-primary);">Your Maximum Budget</h4>
                    </div>
                    <div class="form-hint" style="margin-bottom: 0.75rem; font-size: 0.85rem;">
                        Set the maximum total price you're willing to pay (including items + service fee). Travelers will see this to decide if they can fulfill your request.
                    </div>
                    <div class="form-row" style="align-items: flex-end;">
                        <div class="form-group" style="flex: 2; margin-bottom: 0;">
                            <label class="form-label">Max Total Price <span class="required">*</span></label>
                            <div style="position: relative;">
                                <span id="maxPriceCurrencySymbol" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 600;">‚Ç¨</span>
                                <input type="number" class="form-input" id="reqMaxPrice" placeholder="0.00" step="0.01" min="0" style="padding-left: 28px; font-size: 1.1rem; font-weight: 600;" oninput="updateRequestSummary()">
                            </div>
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Includes</label>
                            <div style="font-size: 0.85rem; color: var(--text-muted); padding: 0.5rem 0;">
                                Items + Service Fee
                            </div>
                        </div>
                    </div>
                    <div id="maxPriceHint" style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--accent-gold); display: none;">
                        <!-- Will show comparison with item budgets -->
                    </div>
                </div>

                <!-- Summary -->
                <div id="requestSummary" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-muted);">Total Items:</span>
                        <span id="summaryTotalItems" style="font-weight: 600;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                        <span style="color: var(--text-muted);">Est. Item Budgets:</span>
                        <span id="summaryTotalBudget" style="font-weight: 600;">‚Ç¨0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                        <span style="color: var(--text-primary); font-weight: 600;">Your Max Budget:</span>
                        <span id="summaryMaxPrice" style="font-weight: 700; color: var(--accent-gold); font-size: 1.1rem;">‚Ç¨0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('createRequest')">Cancel</button>
                <button class="btn btn-primary" onclick="submitNewRequest()">Create Request</button>
            </div>
        </div>
    </div>

    <!-- Create Trip Modal -->
    <div class="modal-overlay" id="modal-createTrip">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add a Trip</h3>
                <button class="modal-close" onclick="hideModal('createTrip')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Departure Airport <span class="required">*</span></label>
                    <div class="airport-select-wrapper">
                        <input type="text" class="form-input airport-search" id="tripFromSearch" placeholder="Search city or airport code..." autocomplete="off" oninput="searchAirportInput('from', this.value)">
                        <input type="hidden" id="tripFromAirport">
                        <input type="hidden" id="tripFromCity">
                        <div class="airport-dropdown" id="tripFromDropdown"></div>
                    </div>
                    <div class="selected-airport" id="tripFromSelected" style="display:none;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Arrival Airport <span class="required">*</span></label>
                    <div class="airport-select-wrapper">
                        <input type="text" class="form-input airport-search" id="tripToSearch" placeholder="Search city or airport code..." autocomplete="off" oninput="searchAirportInput('to', this.value)">
                        <input type="hidden" id="tripToAirport">
                        <input type="hidden" id="tripToCity">
                        <div class="airport-dropdown" id="tripToDropdown"></div>
                    </div>
                    <div class="selected-airport" id="tripToSelected" style="display:none;"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Departure Date <span class="required">*</span></label>
                        <input type="date" class="form-input" id="tripDeparture" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Return Date</label>
                        <input type="date" class="form-input" id="tripReturn" min="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Available Capacity (kg)</label>
                    <input type="number" class="form-input" id="tripCapacity" placeholder="e.g. 5" min="0" max="50" step="0.5">
                </div>

                <!-- Outside Duty-Free Shopping Opt-In -->
                <!-- "Have a shopper at the end of the world for your purchases" -->
                <div class="outside-duty-free-card" style="background: linear-gradient(135deg, rgba(212, 168, 83, 0.1), rgba(45, 212, 191, 0.05)); border: 1px solid var(--accent-gold); border-radius: 12px; padding: 1.25rem; margin-top: 1rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                        <div>
                            <h4 style="font-weight: 600; margin: 0 0 0.25rem 0; color: var(--text-primary);">üõçÔ∏è Willing to shop outside duty free?</h4>
                            <p style="font-size: 0.8rem; color: var(--text-secondary); margin: 0;">City shops, malls, supermarkets, pharmacies, electronics stores, etc.</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tripOutsideDutyFreeOptIn" onchange="toggleOutsideDutyFreeFields()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div id="outsideDutyFreeFields" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(212, 168, 83, 0.3);">
                        <p style="font-size: 0.85rem; color: var(--accent-gold); margin-bottom: 1rem; font-style: italic;">"Have a shopper at the end of the world for your purchases."</p>

                        <div class="form-row" style="gap: 1rem;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Time Budget (minutes) <span class="required">*</span></label>
                                <input type="number" class="form-input" id="tripTimeBudget" placeholder="e.g. 60" min="1" max="240">
                                <span style="font-size: 0.75rem; color: var(--text-muted);">How much time can you spend shopping? (1-240 min)</span>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Max Store Stops <span class="required">*</span></label>
                                <select class="form-input" id="tripMaxStops">
                                    <option value="1">1 store</option>
                                    <option value="2">2 stores</option>
                                    <option value="3" selected>3 stores</option>
                                    <option value="4">4 stores</option>
                                    <option value="5">5 stores</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 0.75rem;">
                            <label class="form-label">Categories you're willing to shop</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                <label class="category-chip"><input type="checkbox" name="tripCategories" value="fashion"> üëï Fashion</label>
                                <label class="category-chip"><input type="checkbox" name="tripCategories" value="electronics"> üì± Electronics</label>
                                <label class="category-chip"><input type="checkbox" name="tripCategories" value="cosmetics"> üíÑ Cosmetics</label>
                                <label class="category-chip"><input type="checkbox" name="tripCategories" value="pharmacy"> üíä Pharmacy</label>
                                <label class="category-chip"><input type="checkbox" name="tripCategories" value="groceries"> üõí Groceries</label>
                                <label class="category-chip"><input type="checkbox" name="tripCategories" value="baby"> üë∂ Baby</label>
                                <label class="category-chip"><input type="checkbox" name="tripCategories" value="gifts"> üéÅ Gifts</label>
                                <label class="category-chip"><input type="checkbox" name="tripCategories" value="other"> üì¶ Other</label>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 0.75rem;">
                            <label class="form-label">Special Constraints (optional)</label>
                            <input type="text" class="form-input" id="tripConstraints" placeholder="e.g. no liquids, no large boxes, no fragile items...">
                        </div>

                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 1rem;">
                            <p style="font-size: 0.8rem; color: var(--text-secondary); margin: 0;">
                                ‚ö†Ô∏è <strong>Legal Notice:</strong> You're responsible for complying with customs rules and local laws. Prohibited items are not allowed.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('createTrip')">Cancel</button>
                <button class="btn btn-primary" onclick="submitTrip()">Add Trip</button>
            </div>
        </div>
    </div>

    <!-- View Request Modal -->
    <div class="modal-overlay" id="modal-viewRequest">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Request Details</h3>
                <button class="modal-close" onclick="hideModal('viewRequest')">√ó</button>
            </div>
            <div class="modal-body" id="viewRequestContent"></div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="modal-auth">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Log In / Sign Up</h3>
                <button class="modal-close" onclick="hideModal('auth')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="authEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Name (for new accounts)</label>
                    <input type="text" class="form-input" id="authName" placeholder="Your Name">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="handleAuth()">Continue</button>
                <p style="text-align: center; margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted);">
                    By continuing, you agree to our Terms of Service.
                </p>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div class="modal-overlay" id="modal-rating">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">‚≠ê Rate Your Experience</h3>
                <button class="modal-close" onclick="hideModal('rating')">√ó</button>
            </div>
            <div class="modal-body">
                <p id="ratingUserName" style="text-align: center; margin-bottom: 1.5rem; color: var(--text-secondary);">Rate your experience with <strong></strong></p>

                <div class="rating-criteria">
                    <div class="rating-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                        <label style="font-weight: 500;">Response to messages</label>
                        <div class="star-rating" data-criterion="response">
                            <span class="star" data-value="1">‚òÖ</span>
                            <span class="star" data-value="2">‚òÖ</span>
                            <span class="star" data-value="3">‚òÖ</span>
                            <span class="star" data-value="4">‚òÖ</span>
                            <span class="star" data-value="5">‚òÖ</span>
                        </div>
                    </div>
                    <div class="rating-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                        <label style="font-weight: 500;">Punctuality</label>
                        <div class="star-rating" data-criterion="punctuality">
                            <span class="star" data-value="1">‚òÖ</span>
                            <span class="star" data-value="2">‚òÖ</span>
                            <span class="star" data-value="3">‚òÖ</span>
                            <span class="star" data-value="4">‚òÖ</span>
                            <span class="star" data-value="5">‚òÖ</span>
                        </div>
                    </div>
                    <div class="rating-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                        <label style="font-weight: 500;">Conformity to request</label>
                        <div class="star-rating" data-criterion="conformity">
                            <span class="star" data-value="1">‚òÖ</span>
                            <span class="star" data-value="2">‚òÖ</span>
                            <span class="star" data-value="3">‚òÖ</span>
                            <span class="star" data-value="4">‚òÖ</span>
                            <span class="star" data-value="5">‚òÖ</span>
                        </div>
                    </div>
                    <div class="rating-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0;">
                        <label style="font-weight: 500;">Delivery / Handover</label>
                        <div class="star-rating" data-criterion="delivery">
                            <span class="star" data-value="1">‚òÖ</span>
                            <span class="star" data-value="2">‚òÖ</span>
                            <span class="star" data-value="3">‚òÖ</span>
                            <span class="star" data-value="4">‚òÖ</span>
                            <span class="star" data-value="5">‚òÖ</span>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="form-label">Feedback (optional)</label>
                    <textarea id="ratingFeedback" class="form-input" rows="3" placeholder="Share your experience..." style="resize: none;"></textarea>
                </div>

                <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="submitRating()">Submit Rating</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Include App JS -->
    <script src="app.js"></script>
    <script src="airports.js"></script>
    <script src="currencies.js"></script>

    <style>
    .airport-select-wrapper { position: relative; }
    .airport-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; max-height: 250px; overflow-y: auto; z-index: 1000; display: none; }
    .airport-dropdown.show { display: block; }
    .airport-option { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border); }
    .airport-option:last-child { border-bottom: none; }
    .airport-option:hover { background: var(--bg-card); }
    .airport-option-code { font-weight: 700; color: var(--accent-gold); margin-right: 0.5rem; }
    .airport-option-city { color: var(--text-primary); }
    .airport-option-country { color: var(--text-secondary); font-size: 0.875rem; }
    .selected-airport { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--bg-card); border: 1px solid var(--accent-gold); border-radius: 8px; margin-top: 0.5rem; }
    .selected-airport-code { font-weight: 700; color: var(--accent-gold); }
    .selected-airport-remove { margin-left: auto; cursor: pointer; color: var(--text-muted); font-size: 1.25rem; }
    .selected-airport-remove:hover { color: var(--text-primary); }

    /* Star Rating Styles */
    .star-rating { display: flex; gap: 0.25rem; }
    .star-rating .star { font-size: 1.5rem; color: var(--border); cursor: pointer; transition: color 0.15s, transform 0.15s; }
    .star-rating .star:hover { transform: scale(1.1); }
    .star-rating .star.active { color: #fbbf24; }
    .star-rating .star.hover { color: #fcd34d; }
    </style>

    <!-- i18n Module Initialization -->
    <script type="module">
    import { i18n } from '/src/i18n/index.js';
    import { initLocaleSelector } from '/src/i18n/locale-selector.js';

    // Initialize locale selector when DOM is ready
    document.addEventListener('DOMContentLoaded', async () => {
        // Get user locale if logged in
        let userLocale = null;
        try {
            const res = await fetch('/api/me', { credentials: 'include' });
            if (res.ok) {
                const data = await res.json();
                userLocale = data.user?.preferredLocale;
            }
        } catch (e) {}

        // Initialize i18n
        await i18n.init({ userLocale });

        // Initialize locale selector
        const container = document.getElementById('locale-selector-dashboard');
        if (container) {
            initLocaleSelector(container, {
                mode: 'full',
                showFlag: true,
                onLocaleChange: () => {
                    // Re-apply translations
                    i18n.apply();
                    if (typeof updatePageText === 'function') updatePageText();
                },
            });
        }
    });
    </script>

    <script>
    // ==========================================
    // DASHBOARD APP LOGIC
    // ==========================================

    let currentFilter = 'all';
    let currentUser = null;

    // ==========================================
    // SESSION CHECK
    // ==========================================

    async function checkSession() {
        try {
            const response = await fetch('/.netlify/functions/me', {
                method: 'GET',
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.user) {
                    currentUser = data.user;
                    // Also update FAE.Auth for compatibility
                    if (typeof FAE !== 'undefined' && FAE.Auth) {
                        FAE.Auth.currentUser = data.user;
                    }
                    // Check email verification status
                    checkEmailVerification();
                    return data.user;
                }
            }
            currentUser = null;
        } catch (e) {
            console.error('Session check failed:', e);
            currentUser = null;
        }
        return null;
    }

    // ==========================================
    // AIRPORT SEARCH
    // ==========================================

    function searchAirportInput(type, query) {
        const dropdown = document.getElementById(`trip${type === 'from' ? 'From' : 'To'}Dropdown`);

        if (!query || query.length < 2) {
            dropdown.classList.remove('show');
            dropdown.innerHTML = '';
            return;
        }

        const results = searchAirports(query);

        if (results.length === 0) {
            dropdown.innerHTML = '<div class="airport-option" style="color: var(--text-muted);">No airports found</div>';
            dropdown.classList.add('show');
            return;
        }

        dropdown.innerHTML = results.map(airport => `
            <div class="airport-option" onclick="selectAirport('${type}', '${airport.code}')">
                <span class="airport-option-code">${airport.code}</span>
                <span class="airport-option-city">${airport.city}</span>
                <span class="airport-option-country">- ${airport.country}</span>
            </div>
        `).join('');
        dropdown.classList.add('show');
    }

    function selectAirport(type, code) {
        const airport = getAirportByCode(code);
        if (!airport) return;

        const prefix = type === 'from' ? 'tripFrom' : 'tripTo';

        document.getElementById(`${prefix}Airport`).value = airport.code;
        document.getElementById(`${prefix}City`).value = airport.city;
        document.getElementById(`${prefix}Search`).value = '';
        document.getElementById(`${prefix}Dropdown`).classList.remove('show');

        const selectedEl = document.getElementById(`${prefix}Selected`);
        selectedEl.innerHTML = `
            <span class="selected-airport-code">${airport.code}</span>
            <span>${airport.city}, ${airport.country}</span>
            <span class="selected-airport-remove" onclick="clearAirport('${type}')">&times;</span>
        `;
        selectedEl.style.display = 'flex';
        document.getElementById(`${prefix}Search`).style.display = 'none';
    }

    function clearAirport(type) {
        const prefix = type === 'from' ? 'tripFrom' : 'tripTo';
        document.getElementById(`${prefix}Airport`).value = '';
        document.getElementById(`${prefix}City`).value = '';
        document.getElementById(`${prefix}Selected`).style.display = 'none';
        document.getElementById(`${prefix}Search`).style.display = 'block';
        document.getElementById(`${prefix}Search`).value = '';
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.airport-select-wrapper')) {
            document.querySelectorAll('.airport-dropdown').forEach(d => d.classList.remove('show'));
        }
    });

    // Language switcher
    function toggleLangDropdown() {
        document.getElementById('langDropdown').classList.toggle('open');
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('langDropdown');
        if (dropdown && !dropdown.contains(e.target)) {
            dropdown.classList.remove('open');
        }
    });
    
    function setLang(lang) {
        T.setLanguage(lang);
        updateLangDropdown();
        updatePageText();
        document.getElementById('langDropdown').classList.remove('open');
    }
    
    function updateLangDropdown() {
        const lang = T.getLanguage();
        // Update button flag
        document.querySelectorAll('.lang-dropdown-btn .flag-img').forEach(img => {
            img.style.display = img.dataset.lang === lang ? 'block' : 'none';
        });
        // Update active state in menu
        document.querySelectorAll('.lang-option').forEach(opt => {
            opt.classList.toggle('active', opt.dataset.lang === lang);
        });
    }
    
    function updateLangButtons() {
        updateLangDropdown();
    }
    
    function updatePageText() {
        // Update all data-i18n elements
        T.updatePage();
        
        // Update page titles and subtitles
        const updates = {
            '#page-dashboard .page-title': 'dashboard.title',
            '#page-dashboard .page-subtitle': 'dashboard.welcome',
            '#page-browse .page-title': 'requests.title',
            '#page-browse .page-subtitle': 'requests.subtitle',
            '#page-my-requests .page-title': 'requests.myTitle',
            '#page-my-requests .page-subtitle': 'requests.mySubtitle',
            '#page-my-trips .page-title': 'trips.title',
            '#page-my-trips .page-subtitle': 'trips.subtitle',
            '#page-deals .page-title': 'deals.title',
            '#page-deals .page-subtitle': 'deals.subtitle',
            '#page-travelers .page-title': 'trips.findTitle',
            '#page-travelers .page-subtitle': 'trips.findSubtitle',
            '#page-settings .page-title': 'nav.settings',
            '#page-settings .page-subtitle': 'nav.account'
        };
        
        Object.entries(updates).forEach(([selector, key]) => {
            const el = document.querySelector(selector);
            if (el) el.textContent = t(key);
        });
        
        // Update stat labels
        const statLabels = document.querySelectorAll('.stat-card-label');
        const statKeys = ['dashboard.walletBalance', 'dashboard.activeDeals', 'dashboard.upcomingTrips', 'dashboard.yourRating'];
        statLabels.forEach((el, i) => {
            if (statKeys[i]) el.textContent = t(statKeys[i]);
        });
        
        // Update section titles
        document.querySelectorAll('.section-title').forEach(el => {
            if (el.textContent.includes('Open Requests') || el.textContent.includes('Otwarte')) {
                el.textContent = t('dashboard.hotRequests');
            }
            if (el.textContent.includes('Quick Actions') || el.textContent.includes('Szybkie')) {
                el.textContent = t('wallet.quickActions');
            }
        });
        
        // Update navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            const icon = link.querySelector('.nav-link-icon');
            const page = link.dataset.page;
            if (icon && page) {
                const iconText = icon.textContent;
                const badge = link.querySelector('.nav-link-badge');
                const navKeys = {
                    'dashboard': 'nav.dashboard',
                    'browse': 'nav.browse',
                    'travelers': 'nav.travelers',
                    'my-requests': 'nav.myRequests',
                    'my-trips': 'nav.myTrips',
                    'deals': 'nav.myDeals',
                    'wallet': 'nav.wallet',
                    'settings': 'nav.settings'
                };
                if (navKeys[page]) {
                    link.innerHTML = `<span class="nav-link-icon">${iconText}</span> ${t(navKeys[page])}`;
                    if (badge) link.appendChild(badge);
                }
            }
        });
        
        // Update nav section titles
        document.querySelectorAll('.nav-section-title').forEach(el => {
            if (el.textContent.includes('Menu')) el.textContent = t('nav.menu');
            if (el.textContent.includes('Activity') || el.textContent.includes('aktywno≈õƒá')) el.textContent = t('nav.activity');
            if (el.textContent.includes('Account') || el.textContent.includes('Konto')) el.textContent = t('nav.account');
        });
        
        // Update buttons
        document.querySelectorAll('button, .btn').forEach(btn => {
            const text = btn.textContent.toLowerCase();
            if (text.includes('create request') || text.includes('utw√≥rz')) {
                btn.innerHTML = '+ ' + t('btn.createRequest');
            } else if (text.includes('add trip') || text.includes('dodaj podr√≥≈º')) {
                btn.innerHTML = '+ ' + t('btn.addTrip');
            } else if (text.includes('view all') || text.includes('zobacz')) {
                btn.textContent = t('btn.viewAll');
            } else if (text.includes('cancel') || text.includes('anuluj')) {
                btn.textContent = t('btn.cancel');
            } else if (text.includes('save') || text.includes('zapisz')) {
                btn.textContent = t('btn.save');
            } else if (text.includes('log out') || text.includes('wyloguj')) {
                btn.textContent = t('btn.logout');
            } else if (text.includes('log in') || text.includes('zaloguj')) {
                btn.textContent = t('btn.login');
            }
        });
        
        // Update filter tabs
        document.querySelectorAll('.tab-btn').forEach(tab => {
            const text = tab.textContent.toLowerCase();
            if (text.includes('all') || text.includes('wszystkie')) tab.textContent = t('requests.all');
            if (text.includes('spirits') || text.includes('alkohole')) tab.textContent = t('cat.spirits');
            if (text.includes('perfume') || text.includes('perfumy')) tab.textContent = t('cat.perfume');
            if (text.includes('electronics') || text.includes('elektronika')) tab.textContent = t('cat.electronics');
        });
        
        // Update modal titles
        document.querySelectorAll('.modal-title').forEach(el => {
            if (el.textContent.includes('Create') || el.textContent.includes('Utw√≥rz')) {
                el.textContent = t('modal.createRequest');
            } else if (el.textContent.includes('Add') || el.textContent.includes('Dodaj')) {
                el.textContent = t('modal.addTrip');
            } else if (el.textContent.includes('Log In') || el.textContent.includes('Zaloguj')) {
                el.textContent = t('modal.auth');
            } else if (el.textContent.includes('Request Details') || el.textContent.includes('Szczeg√≥≈Çy')) {
                el.textContent = t('requests.details');
            }
        });
        
        // Update form labels
        document.querySelectorAll('.form-label').forEach(label => {
            const text = label.textContent.toLowerCase();
            if (text.includes('product name') || text.includes('nazwa produktu')) {
                label.innerHTML = t('form.productName') + ' <span class="required">*</span>';
            } else if (text.includes('category') || text.includes('kategoria')) {
                label.innerHTML = t('form.category') + ' <span class="required">*</span>';
            } else if (text.includes('from airport') || text.includes('z lotniska')) {
                label.innerHTML = t('form.fromAirport') + ' <span class="required">*</span>';
            } else if (text.includes('from city') || text.includes('z miasta')) {
                label.textContent = t('form.fromCity');
            } else if (text.includes('to airport') || text.includes('na lotnisko')) {
                label.innerHTML = t('form.toAirport') + ' <span class="required">*</span>';
            } else if (text.includes('to city') || text.includes('do miasta')) {
                label.textContent = t('form.toCity');
            } else if (text.includes('duty-free price') || text.includes('cena duty')) {
                label.innerHTML = t('form.dutyFreePrice') + ' <span class="required">*</span>';
            } else if (text.includes('service fee') || text.includes('op≈Çata za us≈Çugƒô')) {
                label.innerHTML = t('form.serviceFee') + ' <span class="required">*</span>';
            } else if (text.includes('needed by') || text.includes('potrzebne')) {
                label.innerHTML = t('form.neededBy') + ' <span class="required">*</span>';
            } else if (text.includes('departure') || text.includes('wylot')) {
                label.innerHTML = t('form.departure') + ' <span class="required">*</span>';
            } else if (text.includes('return') || text.includes('powr√≥t')) {
                label.innerHTML = t('form.return') + ' <span class="required">*</span>';
            } else if (text.includes('email')) {
                label.textContent = t('form.email');
            } else if (text.includes('name') || text.includes('imiƒô')) {
                label.textContent = t('form.nameHint');
            } else if (text.includes('display name') || text.includes('wy≈õwietlana')) {
                label.textContent = t('form.displayName');
            } else if (text.includes('location') || text.includes('lokalizacja')) {
                label.textContent = t('form.location');
            }
        });
        
        // Update form hints
        document.querySelectorAll('.form-hint').forEach(hint => {
            if (hint.textContent.includes('15%')) {
                hint.textContent = t('form.serviceFeeHint');
            }
        });
        
        // Update select options
        document.querySelectorAll('.form-select option').forEach(opt => {
            if (opt.value === '') opt.textContent = t('form.selectCategory');
            if (opt.value === 'spirits') opt.textContent = t('cat.spirits');
            if (opt.value === 'perfume') opt.textContent = t('cat.perfume');
            if (opt.value === 'electronics') opt.textContent = t('cat.electronics');
            if (opt.value === 'tobacco') opt.textContent = t('cat.tobacco');
            if (opt.value === 'other') opt.textContent = t('cat.other');
        });
        
        // Update user card for guest
        if (!FAE.Auth.currentUser) {
            document.getElementById('userName').textContent = t('auth.guest');
            document.getElementById('userRole').textContent = t('auth.clickToLogin');
        }
        
        // Reload current page content to update dynamic text
        const activePage = document.querySelector('.nav-link.active');
        if (activePage && activePage.dataset.page) {
            loadPageContent(activePage.dataset.page);
        }
    }
    
    function loadPageContent(page) {
        switch(page) {
            case 'dashboard': loadDashboard(); break;
            case 'browse': loadRequests(); break;
            case 'my-requests': loadMyRequests(); break;
            case 'my-trips': loadMyTrips(); break;
            case 'deals': loadDeals(); break;
            case 'travelers': loadTravelers(); break;
            case 'settings': loadSettings(); break;
            case 'subscription': loadSubscription(); break;
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
        // Check session first to get current user
        await checkSession();

        // Initialize translations
        T.init();
        updateLangButtons();
        updatePageText();

        // Set up navigation
        document.querySelectorAll('.nav-link[data-page]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                showPage(this.dataset.page);
            });
        });

        // User card click
        document.getElementById('userCard').addEventListener('click', function() {
            if (!currentUser) {
                showModal('auth');
            } else {
                showPage('settings');
            }
        });

        // Initialize data and UI
        updateUI();
        showPage('dashboard');
    });
    
    // Page Navigation
    function showPage(page) {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        const pageEl = document.getElementById('page-' + page);
        if (pageEl) pageEl.style.display = 'block';
        
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
        
        // Load page content
        switch(page) {
            case 'dashboard': loadDashboard(); break;
            case 'browse': loadRequests(); break;
            case 'my-requests': loadMyRequests(); break;
            case 'my-trips': loadMyTrips(); break;
            case 'deals': loadDeals(); break;
            case 'messages': loadMessages(); break;
            case 'travelers': loadTravelers(); break;
            case 'settings': loadSettings(); break;
            case 'subscription': loadSubscription(); break;
        }

        // Close mobile sidebar
        document.getElementById('sidebar').classList.remove('show');
        document.getElementById('sidebarOverlay').classList.remove('show');
    }
    
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
        document.getElementById('sidebarOverlay').classList.toggle('show');
    }
    
    // Modal Functions
    function showModal(id) {
        document.getElementById('modal-' + id).classList.add('show');
    }
    
    function hideModal(id) {
        document.getElementById('modal-' + id).classList.remove('show');
    }
    
    // Toast
    function toast(msg, type = 'success') {
        const container = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = 'toast toast-' + type;
        t.innerHTML = `<span class="toast-icon">${type === 'success' ? '‚úì' : '‚úï'}</span><span>${msg}</span><button class="toast-close" onclick="this.parentElement.remove()">√ó</button>`;
        container.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }
    
    // Update UI with user info
    function formatDisplayName(fullName) {
        if (!fullName) return 'User';
        const parts = fullName.trim().split(' ');
        if (parts.length === 1) return parts[0];
        return `${parts[0]} ${parts[parts.length - 1][0]}.`;
    }

    function updateUI() {
        const user = currentUser || FAE.Auth.currentUser;
        if (user) {
            document.getElementById('userAvatar').textContent = user.avatar || user.name.substring(0,2).toUpperCase();
            document.getElementById('userName').textContent = formatDisplayName(user.name);
            const roleDisplay = (user.role === 'TRAVELLER' || user.role === 'traveler') ? '‚úàÔ∏è Traveler' : 'üõçÔ∏è Buyer';
            document.getElementById('userRole').textContent = roleDisplay;
        } else {
            document.getElementById('userAvatar').textContent = '?';
            document.getElementById('userName').textContent = 'Guest';
            document.getElementById('userRole').textContent = 'Click to login';
        }

        // Update request count
        const requests = FAE.Requests.getAll({ status: 'open' });
        document.getElementById('requestsCount').textContent = requests.length;
    }
    
    // Auth
    function handleAuth() {
        const email = document.getElementById('authEmail').value;
        const name = document.getElementById('authName').value;
        
        if (!email) {
            toast('Please enter your email', 'error');
            return;
        }
        
        try {
            // Try to login, will create account if doesn't exist
            const user = FAE.Auth.login(email, '');
            if (name && !user.name.includes('@')) {
                FAE.Auth.updateProfile({ name });
            } else if (name) {
                FAE.Auth.updateProfile({ name, avatar: name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0,2) });
            }
            
            hideModal('auth');
            toast('Welcome, ' + (name || user.name) + '!');
            updateUI();
            loadDashboard();
        } catch(e) {
            toast(e.message, 'error');
        }
    }
    
    function logout() {
        FAE.Auth.logout();
        updateUI();
        showPage('dashboard');
        toast('Logged out');
    }
    
    function requireAuth(callback) {
        if (FAE.Auth.currentUser) {
            callback();
        } else {
            showModal('auth');
        }
    }
    
    // Load Pages
    function loadDashboard() {
        const user = FAE.Auth.currentUser;
        
        if (user) {
            const wallet = FAE.Wallet.get(user.id);
            const deals = FAE.Deals.getForUser(user.id);
            const trips = FAE.Trips.getAll({ travelerId: user.id });
            
            document.getElementById('statBalance').textContent = '‚Ç¨' + wallet.balance.toFixed(2);
            document.getElementById('statDeals').textContent = deals.filter(d => d.status === 'in_progress').length;
            document.getElementById('statTrips').textContent = trips.filter(t => t.status === 'upcoming').length;
            document.getElementById('statRating').textContent = user.rating > 0 ? user.rating.toFixed(1) : '-';
        }
        
        // Hot requests
        const requests = FAE.Requests.getAll({ status: 'open' }).slice(0, 5);
        document.getElementById('hotRequests').innerHTML = requests.length > 0 
            ? '<div class="item-list">' + requests.map(r => renderRequestCard(r)).join('') + '</div>'
            : '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-title">No requests yet</div></div>';
    }
    
    function loadRequests() {
        let requests = FAE.Requests.getAll({ status: 'open' });
        if (currentFilter !== 'all') {
            requests = requests.filter(r => r.category === currentFilter);
        }
        
        document.getElementById('requestsList').innerHTML = requests.length > 0
            ? '<div class="item-list">' + requests.map(r => renderRequestCard(r)).join('') + '</div>'
            : '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-title">No requests found</div></div>';
    }
    
    function loadMyRequests() {
        if (!FAE.Auth.currentUser) {
            document.getElementById('myRequestsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîí</div><div class="empty-state-title">Please log in</div><button class="btn btn-primary" onclick="showModal(\'auth\')">Log In</button></div>';
            return;
        }
        
        const requests = FAE.Requests.getAll({ buyerId: FAE.Auth.currentUser.id });
        document.getElementById('myRequestsList').innerHTML = requests.length > 0
            ? '<div class="item-list">' + requests.map(r => renderRequestCard(r)).join('') + '</div>'
            : '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-title">No requests yet</div><button class="btn btn-primary" onclick="showModal(\'createRequest\')">Create Request</button></div>';
    }
    
    // Note: This function is overwritten by the async version below that uses the API
    
    function loadDeals() {
        if (!FAE.Auth.currentUser) {
            document.getElementById('dealsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîí</div><div class="empty-state-title">Please log in</div><button class="btn btn-primary" onclick="showModal(\'auth\')">Log In</button></div>';
            return;
        }

        const deals = FAE.Deals.getForUser(FAE.Auth.currentUser.id);
        document.getElementById('dealsList').innerHTML = deals.length > 0
            ? '<div class="item-list">' + deals.map(d => renderDealCard(d)).join('') + '</div>'
            : '<div class="empty-state"><div class="empty-state-icon">ü§ù</div><div class="empty-state-title">No deals yet</div></div>';
    }

    let currentConversationId = null;
    let messagePollingInterval = null;

    async function loadMessages() {
        const emptyState = document.getElementById('messagesEmptyState');
        const listContainer = document.getElementById('conversationsList');
        const chatView = document.getElementById('chatView');

        if (!currentUser) {
            emptyState.style.display = 'block';
            emptyState.innerHTML = '<div style="font-size:3rem;margin-bottom:1rem;">üîí</div><p style="font-size:1.1rem;margin-bottom:0.5rem;">Please log in</p><button class="btn btn-primary" onclick="showModal(\'auth\')">Log In</button>';
            listContainer.style.display = 'none';
            chatView.style.display = 'none';
            return;
        }

        try {
            const response = await fetch('/.netlify/functions/messages', {
                credentials: 'include'
            });
            const data = await response.json();

            if (!data.success || !data.conversations || data.conversations.length === 0) {
                emptyState.style.display = 'block';
                emptyState.innerHTML = '<div style="font-size:3rem;margin-bottom:1rem;">üì≠</div><p style="font-size:1.1rem;margin-bottom:0.5rem;">No conversations yet</p><p style="color:var(--text-muted);">Start by contacting a traveler on the homepage</p>';
                listContainer.style.display = 'none';
                chatView.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            listContainer.style.display = 'block';
            chatView.style.display = 'none';

            listContainer.innerHTML = '<div class="item-list">' + data.conversations.map(conv => {
                const isBuyer = conv.buyerId === currentUser.id;
                const otherUser = isBuyer ? conv.traveller : conv.buyer;
                const lastMsg = conv.lastMessage;
                const unread = conv.unreadCount || 0;
                const timeAgo = lastMsg ? formatTimeAgo(lastMsg.createdAt) : '';
                const initial = otherUser.name.charAt(0).toUpperCase();

                return `
                    <div class="item-card" style="cursor:pointer;padding:1rem;margin-bottom:0.75rem;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;gap:1rem;transition:all 0.2s;" onclick="openConversation('${conv.id}')" onmouseover="this.style.borderColor='var(--accent-gold)'" onmouseout="this.style.borderColor='var(--border)'">
                        <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent-gold),var(--accent-teal));display:flex;align-items:center;justify-content:center;font-weight:700;color:#000;font-size:1.25rem;">${initial}</div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;display:flex;align-items:center;gap:0.5rem;">
                                ${otherUser.name}
                                ${unread > 0 ? `<span style="background:var(--accent-gold);color:#000;padding:0.125rem 0.5rem;border-radius:10px;font-size:0.7rem;font-weight:700;">${unread}</span>` : ''}
                            </div>
                            <div style="font-size:0.875rem;color:var(--text-secondary);margin-top:0.25rem;">${conv.trip.fromCity} ‚Üí ${conv.trip.toCity}</div>
                            <div style="font-size:0.8rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px;margin-top:0.25rem;">${lastMsg ? lastMsg.text : 'No messages yet'}</div>
                        </div>
                        <div style="font-size:0.75rem;color:var(--text-muted);white-space:nowrap;">${timeAgo}</div>
                    </div>
                `;
            }).join('') + '</div>';

            updateMessagesCount(data.conversations);
        } catch (e) {
            console.error('Failed to load messages:', e);
            emptyState.style.display = 'block';
            emptyState.innerHTML = '<div style="font-size:3rem;margin-bottom:1rem;">‚ö†Ô∏è</div><p>Failed to load messages</p>';
            listContainer.style.display = 'none';
        }
    }

    let currentConversation = null;
    let currentOtherUser = null;

    async function openConversation(conversationId) {
        currentConversationId = conversationId;
        const emptyState = document.getElementById('messagesEmptyState');
        const listContainer = document.getElementById('conversationsList');
        const chatView = document.getElementById('chatView');

        emptyState.style.display = 'none';
        listContainer.style.display = 'none';
        chatView.style.display = 'block';

        try {
            const response = await fetch(`/.netlify/functions/messages?conversationId=${conversationId}`, {
                credentials: 'include'
            });
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error);
            }

            const conv = data.conversation;
            currentConversation = conv;
            const isBuyer = conv.buyerId === currentUser.id;
            const otherUser = isBuyer ? conv.traveller : conv.buyer;
            currentOtherUser = otherUser;

            document.getElementById('chatWithName').textContent = otherUser.name;
            document.getElementById('chatTripRoute').textContent = `${conv.trip.fromCity} ‚Üí ${conv.trip.toCity}`;

            renderMessages(data.messages);

            // Update UI based on conversation status
            updateChatUIForStatus(conv);

            // Start polling for new messages
            if (messagePollingInterval) clearInterval(messagePollingInterval);
            messagePollingInterval = setInterval(() => refreshMessages(conversationId), 5000);

            // Update unread count
            updateMessagesCount();
        } catch (e) {
            console.error('Failed to open conversation:', e);
            toast('Failed to load conversation', 'error');
        }
    }

    async function updateChatUIForStatus(conv) {
        const statusBadge = document.getElementById('chatStatusBadge');
        const markCompleteBtn = document.getElementById('markCompleteBtn');
        const chatInputArea = document.getElementById('chatInputArea');
        const completedActions = document.getElementById('completedActions');
        const rateNowBtn = document.getElementById('rateNowBtn');
        const alreadyRated = document.getElementById('alreadyRated');

        if (conv.status === 'COMPLETED') {
            // Show completed badge
            statusBadge.style.display = 'inline-block';
            statusBadge.textContent = 'Completed';
            statusBadge.style.background = 'rgba(34, 197, 94, 0.2)';
            statusBadge.style.color = '#22c55e';

            // Hide mark complete button
            markCompleteBtn.style.display = 'none';

            // Hide chat input, show completed actions
            chatInputArea.style.display = 'none';
            completedActions.style.display = 'block';

            // Check if user has already rated
            const hasRated = await checkIfUserRated(conv.id);
            if (hasRated) {
                rateNowBtn.style.display = 'none';
                alreadyRated.style.display = 'inline';
            } else {
                rateNowBtn.style.display = 'inline-block';
                alreadyRated.style.display = 'none';
            }
        } else {
            // Active conversation
            statusBadge.style.display = 'none';
            markCompleteBtn.style.display = 'inline-block';
            chatInputArea.style.display = 'flex';
            completedActions.style.display = 'none';
        }
    }

    async function checkIfUserRated(conversationId) {
        try {
            const response = await fetch(`/.netlify/functions/ratings?userId=${currentUser.id}`, {
                credentials: 'include'
            });
            const data = await response.json();
            if (data.success && data.ratings) {
                return data.ratings.some(r => r.conversationId === conversationId && r.fromUserId === currentUser.id);
            }
        } catch (e) {
            console.error('Failed to check rating status:', e);
        }
        return false;
    }

    function renderMessages(messages) {
        const container = document.getElementById('chatMessages');
        container.innerHTML = messages.map(msg => {
            const isMe = msg.senderId === currentUser.id;
            return `
                <div style="display:flex;justify-content:${isMe ? 'flex-end' : 'flex-start'};">
                    <div style="max-width:70%;padding:0.75rem 1rem;border-radius:16px;background:${isMe ? 'var(--accent-gold)' : 'var(--bg-card)'};color:${isMe ? '#000' : 'var(--text-primary)'};">
                        <div style="font-size:0.875rem;">${escapeHtml(msg.text)}</div>
                        <div style="font-size:0.7rem;margin-top:0.25rem;opacity:0.7;">${formatTimeAgo(msg.createdAt)}</div>
                    </div>
                </div>
            `;
        }).join('');
        container.scrollTop = container.scrollHeight;
    }

    async function refreshMessages(conversationId) {
        if (currentConversationId !== conversationId) return;
        try {
            const response = await fetch(`/.netlify/functions/messages?conversationId=${conversationId}`, {
                credentials: 'include'
            });
            const data = await response.json();
            if (data.success) {
                renderMessages(data.messages);
            }
        } catch (e) {
            console.error('Failed to refresh messages:', e);
        }
    }

    async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text || !currentConversationId) return;

        input.value = '';
        input.disabled = true;

        try {
            // Get trip ID from current conversation
            const convResponse = await fetch(`/.netlify/functions/messages?conversationId=${currentConversationId}`, {
                credentials: 'include'
            });
            const convData = await convResponse.json();
            const tripId = convData.conversation.tripId;

            const response = await fetch('/.netlify/functions/messages', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tripId, text })
            });

            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error);
            }

            // Refresh messages
            refreshMessages(currentConversationId);
        } catch (e) {
            console.error('Failed to send message:', e);
            toast('Failed to send message', 'error');
            input.value = text;
        } finally {
            input.disabled = false;
            input.focus();
        }
    }

    function closeChatView() {
        if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
            messagePollingInterval = null;
        }
        currentConversationId = null;
        currentConversation = null;
        currentOtherUser = null;
        document.getElementById('chatView').style.display = 'none';
        loadMessages();
    }

    // ==========================================
    // RATING SYSTEM
    // ==========================================

    let ratingScores = {
        response: 0,
        punctuality: 0,
        conformity: 0,
        delivery: 0
    };

    async function markTransactionComplete() {
        if (!currentConversationId) return;

        try {
            const response = await fetch('/.netlify/functions/messages', {
                method: 'PUT',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversationId: currentConversationId,
                    action: 'complete'
                })
            });

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error);
            }

            toast('Transaction marked as completed!', 'success');

            // Update UI
            currentConversation.status = 'COMPLETED';
            await updateChatUIForStatus(currentConversation);

            // Prompt to rate
            setTimeout(() => {
                openRatingModal();
            }, 500);

        } catch (e) {
            console.error('Failed to mark complete:', e);
            toast(e.message || 'Failed to mark transaction complete', 'error');
        }
    }

    function openRatingModal() {
        if (!currentOtherUser) return;

        // Reset scores
        ratingScores = { response: 0, punctuality: 0, conformity: 0, delivery: 0 };

        // Update modal with user name
        document.querySelector('#ratingUserName strong').textContent = currentOtherUser.name;

        // Reset stars
        document.querySelectorAll('.star-rating .star').forEach(star => {
            star.classList.remove('active');
        });

        // Reset feedback
        document.getElementById('ratingFeedback').value = '';

        // Show modal
        showModal('rating');

        // Initialize star click handlers
        initStarRatings();
    }

    function initStarRatings() {
        document.querySelectorAll('.star-rating').forEach(ratingContainer => {
            const criterion = ratingContainer.dataset.criterion;
            const stars = ratingContainer.querySelectorAll('.star');

            stars.forEach(star => {
                star.onclick = () => {
                    const value = parseInt(star.dataset.value);
                    ratingScores[criterion] = value;

                    // Update star display
                    stars.forEach(s => {
                        const sValue = parseInt(s.dataset.value);
                        if (sValue <= value) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                };

                star.onmouseenter = () => {
                    const value = parseInt(star.dataset.value);
                    stars.forEach(s => {
                        const sValue = parseInt(s.dataset.value);
                        if (sValue <= value) {
                            s.classList.add('hover');
                        }
                    });
                };

                star.onmouseleave = () => {
                    stars.forEach(s => s.classList.remove('hover'));
                };
            });
        });
    }

    async function submitRating() {
        // Validate all ratings are set
        if (ratingScores.response === 0 || ratingScores.punctuality === 0 ||
            ratingScores.conformity === 0 || ratingScores.delivery === 0) {
            toast('Please rate all categories', 'error');
            return;
        }

        const feedback = document.getElementById('ratingFeedback').value.trim();

        try {
            const response = await fetch('/.netlify/functions/ratings', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversationId: currentConversationId,
                    responseScore: ratingScores.response,
                    punctualityScore: ratingScores.punctuality,
                    conformityScore: ratingScores.conformity,
                    deliveryScore: ratingScores.delivery,
                    feedback: feedback || null
                })
            });

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error);
            }

            hideModal('rating');
            toast('Rating submitted! Thank you for your feedback.', 'success');

            // Update UI to show already rated
            document.getElementById('rateNowBtn').style.display = 'none';
            document.getElementById('alreadyRated').style.display = 'inline';

        } catch (e) {
            console.error('Failed to submit rating:', e);
            toast(e.message || 'Failed to submit rating', 'error');
        }
    }

    function formatTimeAgo(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
        if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
        return date.toLocaleDateString();
    }

    async function updateMessagesCount(conversations) {
        if (!currentUser) return;

        let count = 0;
        if (conversations) {
            conversations.forEach(c => { count += c.unreadCount || 0; });
        } else {
            try {
                const response = await fetch('/.netlify/functions/messages', { credentials: 'include' });
                const data = await response.json();
                if (data.success && data.conversations) {
                    data.conversations.forEach(c => { count += c.unreadCount || 0; });
                }
            } catch (e) { /* ignore */ }
        }

        const badge = document.getElementById('messagesCount');
        if (badge) {
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function openChatModal(conversationId) {
        // Redirect to main site with messages modal
        window.location.href = 'index.html?openMessages=' + conversationId;
    }

    // Debounce for search input
    let searchTimeout = null;
    function debounceSearch() {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => searchTravelers(), 300);
    }

    // Search travelers with API (supports outside duty-free filter)
    async function searchTravelers() {
        const container = document.getElementById('travelersList');
        if (!container) return;

        const destination = document.getElementById('travelerSearchDestination')?.value?.trim() || '';
        const outsideDutyFree = document.getElementById('travelerSearchOutsideDutyFree')?.checked || false;

        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

        try {
            // Build query params
            const params = new URLSearchParams();
            if (destination) params.append('destination', destination);
            if (outsideDutyFree) params.append('outsideDutyFree', '1');
            params.append('limit', '50');

            const response = await fetch(`/.netlify/functions/traveller-search?${params.toString()}`);
            const data = await response.json();

            if (!data.success || !data.travellers || data.travellers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úàÔ∏è</div>
                        <div class="empty-state-title">No travelers found</div>
                        <p style="color: var(--text-muted);">Try adjusting your search filters</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="item-list">' + data.travellers.map(t => {
                // Build badge HTML if traveler has outside duty-free opt-in
                const odfBadge = t.outsideDutyFree ? `
                    <div class="odf-badge" style="margin-top: 0.5rem;">
                        üõçÔ∏è ${t.outsideDutyFree.badge}
                        <span style="color: var(--text-muted); font-size: 0.7rem; margin-left: 0.25rem;">
                            ${t.outsideDutyFree.timeBudget}min ‚Ä¢ ${t.outsideDutyFree.maxStops} stops
                        </span>
                    </div>
                ` : '';

                // Rating display
                const ratingDisplay = t.traveller.avgRating
                    ? `‚≠ê ${t.traveller.avgRating.toFixed(1)} (${t.traveller.totalRatings})`
                    : 'New traveler';

                return `
                    <div class="item-card" style="cursor: pointer;" onclick="viewTripDetails('${t.tripId}')">
                        <div class="user-avatar">${(t.traveller.name || '?')[0].toUpperCase()}</div>
                        <div class="item-details">
                            <div class="item-title">${t.traveller.name || 'Unknown'}</div>
                            <div class="item-meta">${ratingDisplay} ‚Ä¢ ${t.traveller.city || ''}, ${t.traveller.country || ''}</div>
                            <div class="item-route">
                                <span>${t.origin.airport} ${t.origin.city}</span>
                                <span class="arrow">‚Üí</span>
                                <span>${t.destination.airport} ${t.destination.city}</span>
                            </div>
                            ${odfBadge}
                        </div>
                        <div class="item-price">
                            <div class="item-price-label">${formatDate(t.departureDate)}</div>
                            ${t.availableKg ? `<div style="font-size: 0.8rem; color: var(--text-muted);">${t.availableKg}kg available</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('') + '</div>';

        } catch (error) {
            console.error('Error searching travelers:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <div class="empty-state-title">Error loading travelers</div>
                    <button class="btn btn-primary" onclick="searchTravelers()">Try Again</button>
                </div>
            `;
        }
    }

    // Legacy local data version (fallback)
    function loadTravelers() {
        // Try API search first
        searchTravelers();
    }

    // Subscription Management
    let currentSubscription = null;

    async function loadSubscription() {
        const statusEl = document.getElementById('subscriptionStatus');

        try {
            const response = await fetch('/.netlify/functions/subscriptions/status');
            const data = await response.json();

            if (data.hasActiveSubscription && data.subscription) {
                currentSubscription = data.subscription;
                const sub = data.subscription;
                const remaining = sub.remainingPurchases === null ? 'Unlimited' : sub.remainingPurchases;
                const endDate = new Date(sub.endDate).toLocaleDateString();

                statusEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Current Plan</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-gold);">${sub.planName}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Purchases Used</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${sub.purchasesUsed} / ${sub.purchaseLimit || '‚àû'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Remaining</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-teal);">${remaining}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Valid Until</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${endDate}</div>
                        </div>
                    </div>
                `;

                // Update plan buttons to show current plan
                document.querySelectorAll('.subscription-plan-card').forEach(card => {
                    const btn = card.querySelector('.subscribe-plan-btn');
                    if (card.dataset.tier === sub.tier) {
                        btn.textContent = 'Current Plan';
                        btn.disabled = true;
                        btn.classList.add('btn-secondary');
                        btn.classList.remove('btn-primary', 'btn-outline');
                    } else {
                        btn.textContent = 'Select ' + card.dataset.tier.charAt(0) + card.dataset.tier.slice(1).toLowerCase();
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                    }
                });
            } else {
                currentSubscription = null;
                statusEl.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                        <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">No Active Subscription</div>
                        <div style="color: var(--text-muted);">Choose a plan below to start making purchases</div>
                    </div>
                `;

                // Enable all plan buttons
                document.querySelectorAll('.subscription-plan-card').forEach(card => {
                    const btn = card.querySelector('.subscribe-plan-btn');
                    btn.textContent = 'Select ' + card.dataset.tier.charAt(0) + card.dataset.tier.slice(1).toLowerCase();
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
            }
        } catch (error) {
            console.error('Failed to load subscription:', error);
            statusEl.innerHTML = '<div class="empty-state"><div class="empty-state-title">Failed to load subscription status</div></div>';
        }
    }

    // Handle subscription button clicks
    document.addEventListener('click', async function(e) {
        if (e.target.classList.contains('subscribe-plan-btn') && !e.target.disabled) {
            const tier = e.target.dataset.tier;
            const btn = e.target;
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                const response = await fetch('/.netlify/functions/subscriptions/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ planTier: tier })
                });

                const data = await response.json();

                if (data.checkout && data.checkout.url) {
                    window.location.href = data.checkout.url;
                } else if (data.error) {
                    alert(data.error + (data.details ? ': ' + data.details : ''));
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error('Subscription error:', error);
                alert('Failed to start subscription. Please try again.');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    });

    function loadSettings() {
        if (!FAE.Auth.currentUser) return;
        document.getElementById('settingsName').value = FAE.Auth.currentUser.name || '';
        document.getElementById('settingsEmail').value = FAE.Auth.currentUser.email || '';
        document.getElementById('settingsCity').value = FAE.Auth.currentUser.city || '';
        document.getElementById('settingsCountry').value = FAE.Auth.currentUser.country || '';
        // Load role checkboxes
        document.getElementById('settingsIsBuyer').checked = FAE.Auth.currentUser.isBuyer !== false;
        document.getElementById('settingsIsTraveler').checked = FAE.Auth.currentUser.isTraveler === true;
        updateRoleStyle();
        handleSettingsCountryChange();
    }

    function updateRoleStyle() {
        const buyerChecked = document.getElementById('settingsIsBuyer').checked;
        const travelerChecked = document.getElementById('settingsIsTraveler').checked;
        const buyerLabel = document.getElementById('roleBuyerLabel');
        const travelerLabel = document.getElementById('roleTravelerLabel');

        buyerLabel.style.borderColor = buyerChecked ? 'var(--accent-gold)' : 'transparent';
        buyerLabel.style.background = buyerChecked ? 'rgba(212, 175, 55, 0.1)' : 'var(--bg-secondary)';
        travelerLabel.style.borderColor = travelerChecked ? 'var(--accent-gold)' : 'transparent';
        travelerLabel.style.background = travelerChecked ? 'rgba(212, 175, 55, 0.1)' : 'var(--bg-secondary)';
    }

    function handleSettingsCountryChange() {
        const country = document.getElementById('settingsCountry').value;
        const notice = document.getElementById('settingsCurrencyNotice');
        if (country) {
            const currency = country.toLowerCase() === 'poland' ? 'PLN' : 'EUR';
            const currencyName = currency === 'PLN' ? 'Polish Zloty' : 'Euro';
            notice.textContent = `Your wallet currency: ${currency} (${currencyName})`;
            notice.style.display = 'block';
        } else {
            notice.style.display = 'none';
        }
    }

    async function saveSettings() {
        if (!FAE.Auth.currentUser) return;

        const isBuyer = document.getElementById('settingsIsBuyer').checked;
        const isTraveler = document.getElementById('settingsIsTraveler').checked;

        // Must have at least one role
        if (!isBuyer && !isTraveler) {
            toast('Please select at least one role (Buyer or Traveler)', 'error');
            return;
        }

        try {
            const res = await fetch('/.netlify/functions/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    name: document.getElementById('settingsName').value,
                    city: document.getElementById('settingsCity').value,
                    country: document.getElementById('settingsCountry').value,
                    isBuyer: isBuyer,
                    isTraveler: isTraveler
                })
            });
            const data = await res.json();
            if (data.success) {
                FAE.Auth.currentUser = { ...FAE.Auth.currentUser, ...data.user };
                toast('Settings saved!' + (data.walletCurrencyUpdated ? ` Wallet currency updated to ${data.newCurrency}.` : ''));
                updateUI();
            } else {
                toast(data.error || 'Failed to save settings', 'error');
            }
        } catch (e) {
            toast('Error saving settings: ' + e.message, 'error');
        }
    }

    // GDPR Functions
    function exportUserData() {
        if (!FAE.Auth.currentUser) {
            toast('Please log in first', 'error');
            return;
        }
        try {
            FAE.Auth.exportData();
            toast('Data exported successfully! Check your downloads.');
        } catch (e) {
            toast('Error exporting data: ' + e.message, 'error');
        }
    }

    function confirmDeleteAccount() {
        if (!FAE.Auth.currentUser) {
            toast('Please log in first', 'error');
            return;
        }

        const confirmed = confirm(
            'Are you sure you want to delete your account?\n\n' +
            'This will permanently delete:\n' +
            '‚Ä¢ Your profile and personal data\n' +
            '‚Ä¢ All your requests and trips\n' +
            '‚Ä¢ Your wallet and transaction history\n' +
            '‚Ä¢ All messages and notifications\n\n' +
            'This action cannot be undone.'
        );

        if (confirmed) {
            try {
                FAE.Auth.deleteAccount();
                toast('Account deleted successfully');
                window.location.href = '/';
            } catch (e) {
                toast('Error deleting account: ' + e.message, 'error');
            }
        }
    }

    // Render Cards
    function renderRequestCard(req) {
        const buyer = FAE.Users.getById(req.buyerId);

        // Get display info from items or legacy fields
        const items = req.items || [];
        const firstItem = items[0] || {};
        const itemCount = items.length;
        const totalQty = items.reduce((sum, i) => sum + (i.quantity || 1), 0);

        // Product name: show first item or legacy product field
        const productName = firstItem.itemName || req.product || 'Request';
        const category = firstItem.category || req.category;
        const icon = { spirits: 'ü•É', perfume: '‚ú®', electronics: 'üì±', tobacco: 'üö¨', fashion: 'üëó', other: 'üì¶' }[category] || 'üì¶';

        // Request type indicator
        const typeIcon = req.requestType === 'OUTSIDE_DUTY_FREE' ? 'üõçÔ∏è' :
                        req.requestType === 'BOTH' ? 'üì¶' : '‚úàÔ∏è';
        const typeLabel = req.requestType === 'OUTSIDE_DUTY_FREE' ? 'Regular Store' :
                         req.requestType === 'BOTH' ? 'Mixed' : 'Duty-Free';

        // Budget display
        const totalBudget = req.totalBudget || firstItem.budgetPrice || req.dutyFreePrice || 0;
        const maxPrice = req.maxPrice;
        const currency = req.currency || 'EUR';
        const currencySymbol = currency === 'PLN' ? 'z≈Ç' : currency === 'USD' ? '$' : currency === 'GBP' ? '¬£' : '‚Ç¨';

        // Item summary
        const itemSummary = itemCount > 1 ? `${itemCount} items (${totalQty} qty)` : productName;

        // Price display - show max price prominently if set
        const priceDisplay = maxPrice && maxPrice > 0
            ? `<div class="item-price-value" style="color: var(--accent-gold);">${currencySymbol}${maxPrice.toFixed(2)}</div>
               <div class="item-price-label">max budget</div>`
            : `<div class="item-price-value">${currencySymbol}${totalBudget.toFixed(2)}</div>
               <div class="item-price-label">item budget</div>`;

        return `
            <div class="item-card" onclick="viewRequest('${req.id}')">
                <div class="item-icon">${icon}</div>
                <div class="item-details">
                    <div class="item-title">${itemSummary}</div>
                    <div class="item-meta">
                        ${typeIcon} ${typeLabel} ‚Ä¢ ${buyer?.name || 'Unknown'} ‚Ä¢ ${req.offers?.length || req.offerCount || 0} offers
                    </div>
                    <div class="item-route">
                        <span>${req.fromAirport} ${req.fromCity || ''}</span>
                        <span class="arrow">‚Üí</span>
                        <span>${req.toAirport} ${req.toCity || ''}</span>
                    </div>
                </div>
                <div class="item-price">
                    ${priceDisplay}
                </div>
                <span class="item-status status-${req.status}">${req.status}</span>
            </div>
        `;
    }
    
    function renderTripCard(trip) {
        return `
            <div class="item-card">
                <div class="item-icon">‚úàÔ∏è</div>
                <div class="item-details">
                    <div class="item-route" style="margin:0;">
                        <span>${trip.fromAirport} ${trip.fromCity}</span>
                        <span class="arrow">‚Üí</span>
                        <span>${trip.toAirport} ${trip.toCity}</span>
                    </div>
                    <div class="item-meta" style="margin-top: 0.5rem;">üìÖ ${formatDate(trip.departureDate)} - ${formatDate(trip.returnDate)}</div>
                </div>
                <span class="item-status status-${trip.status}">${trip.status}</span>
            </div>
        `;
    }
    
    function renderDealCard(deal) {
        const icon = { spirits: 'ü•É', perfume: '‚ú®', electronics: 'üì±' }[deal.category] || 'üì¶';
        return `
            <div class="item-card">
                <div class="item-icon">${icon}</div>
                <div class="item-details">
                    <div class="item-title">${deal.product}</div>
                    <div class="item-meta">Deal #${deal.id.substring(1)}</div>
                </div>
                <div class="item-price">
                    <div class="item-price-value">‚Ç¨${deal.totalAmount.toFixed(2)}</div>
                </div>
                <span class="item-status status-${deal.status}">${deal.status.replace('_', ' ')}</span>
            </div>
        `;
    }
    
    // Actions
    function filterRequests(cat) {
        currentFilter = cat;
        document.querySelectorAll('#requestTabs .tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        loadRequests();
    }
    
    function viewRequest(id) {
        const req = FAE.Requests.getById(id);
        if (!req) return;

        const buyer = FAE.Users.getById(req.buyerId);
        const isOwner = FAE.Auth.currentUser?.id === req.buyerId;
        const hasOffered = req.offers?.includes(FAE.Auth.currentUser?.id);

        // Get items from request
        const items = req.items || [];
        const hasItems = items.length > 0;

        // Request type display
        const typeIcon = req.requestType === 'OUTSIDE_DUTY_FREE' ? 'üõçÔ∏è' :
                        req.requestType === 'BOTH' ? 'üì¶' : '‚úàÔ∏è';
        const typeLabel = req.requestType === 'OUTSIDE_DUTY_FREE' ? 'Outside Duty-Free' :
                         req.requestType === 'BOTH' ? 'Mixed (Duty-Free + Other)' : 'Duty-Free';

        // Currency
        const currency = req.currency || 'EUR';
        const currencySymbol = currency === 'PLN' ? 'z≈Ç' : currency === 'USD' ? '$' : currency === 'GBP' ? '¬£' : '‚Ç¨';

        // Build items HTML
        let itemsHtml = '';
        if (hasItems) {
            itemsHtml = '<h4 style="margin: 1rem 0 0.5rem; color: var(--text-muted);">Items Requested:</h4>';
            itemsHtml += items.map((item, idx) => {
                const sourceIcon = item.itemSource === 'OUTSIDE_DUTY_FREE' ? 'üõçÔ∏è' : '‚úàÔ∏è';
                const sourceLabel = item.itemSource === 'OUTSIDE_DUTY_FREE' ? 'Regular Store' : 'Duty-Free';
                const categoryIcon = { spirits: 'ü•É', perfume: '‚ú®', electronics: 'üì±', tobacco: 'üö¨', fashion: 'üëó', other: 'üì¶' }[item.category] || '';

                let extraInfo = '';
                if (item.itemSource === 'OUTSIDE_DUTY_FREE') {
                    if (item.storeName) extraInfo += `<div style="font-size:0.85rem;color:var(--text-muted);">Store: ${item.storeName}</div>`;
                    if (item.storeUrl) extraInfo += `<div style="font-size:0.85rem;"><a href="${item.storeUrl}" target="_blank" style="color:var(--accent-gold);">Product Link</a></div>`;
                    if (item.buyRegion) extraInfo += `<div style="font-size:0.85rem;color:var(--text-muted);">Buy in: ${item.buyRegion}</div>`;
                    if (item.acceptAlternatives) extraInfo += `<div style="font-size:0.85rem;color:var(--accent-gold);">‚úì Accepts alternatives</div>`;
                } else {
                    if (item.preferredBrand) extraInfo += `<div style="font-size:0.85rem;color:var(--text-muted);">Brand: ${item.preferredBrand}</div>`;
                    if (item.dutyFreeStore) extraInfo += `<div style="font-size:0.85rem;color:var(--text-muted);">Store: ${item.dutyFreeStore}</div>`;
                }
                if (item.notes) extraInfo += `<div style="font-size:0.85rem;color:var(--text-muted);">Notes: ${item.notes}</div>`;

                return `
                    <div style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-weight: 600;">${categoryIcon} ${item.itemName}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    ${sourceIcon} ${sourceLabel} ‚Ä¢ Qty: ${item.quantity || 1}
                                </div>
                                ${extraInfo}
                            </div>
                            <div style="text-align: right;">
                                ${item.budgetPrice ? `<div style="font-weight:600;">${currencySymbol}${item.budgetPrice.toFixed(2)}</div><div style="font-size:0.75rem;color:var(--text-muted);">budget</div>` : '<span style="color:var(--text-muted);font-size:0.85rem;">No budget set</span>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Offers section
        let offersHtml = '';
        if (isOwner && req.offers?.length > 0) {
            offersHtml = '<h4 style="margin: 1rem 0 0.5rem; color: var(--text-muted);">Offers:</h4>' + req.offers.map(tid => {
                const t = FAE.Users.getById(tid);
                return `<div class="item-card" style="margin-bottom:0.5rem;"><div class="user-avatar" style="width:32px;height:32px;font-size:0.7rem;">${t?.avatar||'?'}</div><div class="item-details"><div class="item-title">${t?.name||'Unknown'}</div></div><button class="btn btn-primary btn-sm" onclick="acceptOffer('${id}','${tid}')">Accept</button></div>`;
            }).join('');
        }

        // Legacy display for old requests without items
        let legacyInfo = '';
        if (!hasItems && req.product) {
            legacyInfo = `
                <div class="deal-breakdown-row"><span class="deal-breakdown-label">Product</span><span>${req.product}</span></div>
                <div class="deal-breakdown-row"><span class="deal-breakdown-label">Price</span><span>${currencySymbol}${req.dutyFreePrice || 0}</span></div>
                ${req.serviceFee ? `<div class="deal-breakdown-row"><span class="deal-breakdown-label">Service Fee</span><span>+${currencySymbol}${req.serviceFee}</span></div>` : ''}
            `;
        }

        // Max price display
        const maxPriceDisplay = req.maxPrice && req.maxPrice > 0
            ? `<div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05)); border: 2px solid var(--accent-gold); border-radius: 10px; padding: 1rem; margin: 1rem 0; text-align: center;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Buyer's Maximum Budget</div>
                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--accent-gold);">${currencySymbol}${req.maxPrice.toFixed(2)}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">includes items + your service fee</div>
                </div>`
            : '';

        document.getElementById('viewRequestContent').innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1.5rem;">${typeIcon}</span>
                <div>
                    <h2 style="margin: 0;">${hasItems ? `${items.length} Item${items.length > 1 ? 's' : ''} Requested` : req.product}</h2>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">${typeLabel}</div>
                </div>
            </div>
            ${maxPriceDisplay}
            <div class="deal-breakdown" style="margin: 1rem 0;">
                <div class="deal-breakdown-row"><span class="deal-breakdown-label">Route</span><span>${req.fromAirport} ${req.fromCity || ''} ‚Üí ${req.toAirport} ${req.toCity || ''}</span></div>
                ${req.totalBudget ? `<div class="deal-breakdown-row"><span class="deal-breakdown-label">Item Budgets Total</span><span>${currencySymbol}${req.totalBudget.toFixed(2)}</span></div>` : ''}
                <div class="deal-breakdown-row"><span class="deal-breakdown-label">Needed By</span><span>${req.neededBy ? formatDate(req.neededBy) : 'Not specified'}</span></div>
                <div class="deal-breakdown-row"><span class="deal-breakdown-label">Buyer</span><span>${buyer?.name || 'Unknown'}</span></div>
                ${legacyInfo}
            </div>
            ${req.generalNotes ? `<div style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;"><strong>Notes:</strong> ${req.generalNotes}</div>` : ''}
            ${itemsHtml}
            ${offersHtml}
            ${!isOwner && (req.status === 'open' || req.status === 'OPEN') ? `<button class="btn btn-primary" style="width:100%;margin-top:1rem;" onclick="makeOffer('${id}')" ${hasOffered ? 'disabled' : ''}>${hasOffered ? 'Offer Sent' : 'Make an Offer'}</button>` : ''}
        `;

        showModal('viewRequest');
    }
    
    function makeOffer(requestId) {
        requireAuth(() => {
            try {
                FAE.Requests.makeOffer(requestId);
                toast('Offer sent!');
                hideModal('viewRequest');
                loadRequests();
            } catch(e) {
                toast(e.message, 'error');
            }
        });
    }
    
    function acceptOffer(requestId, travelerId) {
        requireAuth(() => {
            try {
                FAE.Requests.acceptOffer(requestId, travelerId);
                toast('Offer accepted! Deal created.');
                hideModal('viewRequest');
                showPage('deals');
            } catch(e) {
                toast(e.message, 'error');
            }
        });
    }
    
    // ==========================================
    // NEW REQUEST FORM - Multi-Item Support
    // ==========================================

    let currentRequestType = 'DUTY_FREE';
    let requestItems = [];
    let requestItemCounter = 0;

    function selectRequestType(type) {
        currentRequestType = type;
        // Update visual selection
        document.querySelectorAll('.request-type-option .request-type-card').forEach(card => {
            card.style.borderColor = 'transparent';
        });
        const selectedCard = document.querySelector(`#reqType${type === 'DUTY_FREE' ? 'DF' : type === 'OUTSIDE_DUTY_FREE' ? 'ODF' : 'Both'} .request-type-card`);
        if (selectedCard) {
            selectedCard.style.borderColor = 'var(--accent-gold)';
        }

        // Show/hide customs notice
        const notice = document.getElementById('customsNotice');
        if (type === 'OUTSIDE_DUTY_FREE' || type === 'BOTH') {
            notice.style.display = 'block';
        } else {
            notice.style.display = 'none';
        }

        // Show/hide outside duty-free preferences
        // "Have a shopper at the end of the world for your purchases"
        const odfPrefs = document.getElementById('outsideDutyFreePrefs');
        if (odfPrefs) {
            odfPrefs.style.display = (type === 'OUTSIDE_DUTY_FREE' || type === 'BOTH') ? 'block' : 'none';
        }

        // Update existing items' source selector visibility
        updateItemSourceSelectors();
    }

    function updateItemSourceSelectors() {
        const selectors = document.querySelectorAll('.item-source-selector');
        selectors.forEach(sel => {
            sel.style.display = currentRequestType === 'BOTH' ? 'block' : 'none';
        });
    }

    function getItemSourceForType() {
        if (currentRequestType === 'DUTY_FREE') return 'DUTY_FREE';
        if (currentRequestType === 'OUTSIDE_DUTY_FREE') return 'OUTSIDE_DUTY_FREE';
        return 'DUTY_FREE'; // Default for BOTH
    }

    function addRequestItem(initialData = null) {
        requestItemCounter++;
        const itemId = `item-${requestItemCounter}`;
        const itemSource = initialData?.itemSource || getItemSourceForType();
        const isOutside = itemSource === 'OUTSIDE_DUTY_FREE';

        const itemHtml = `
            <div class="request-item" id="${itemId}" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <span style="font-weight: 600; color: var(--text-primary);">Item #${requestItemCounter}</span>
                    <button type="button" onclick="removeRequestItem('${itemId}')" style="background: none; border: none; color: var(--accent-red); cursor: pointer; font-size: 1.25rem;">√ó</button>
                </div>

                <!-- Item Source (only for BOTH type) -->
                <div class="form-group item-source-selector" style="display: ${currentRequestType === 'BOTH' ? 'block' : 'none'}; margin-bottom: 0.75rem;">
                    <label class="form-label">Item Type</label>
                    <select class="form-select item-source" onchange="toggleItemFields('${itemId}')">
                        <option value="DUTY_FREE" ${itemSource === 'DUTY_FREE' ? 'selected' : ''}>‚úàÔ∏è Duty-Free</option>
                        <option value="OUTSIDE_DUTY_FREE" ${itemSource === 'OUTSIDE_DUTY_FREE' ? 'selected' : ''}>üõçÔ∏è Outside Duty-Free</option>
                    </select>
                </div>

                <!-- Basic Info -->
                <div class="form-row" style="gap: 0.75rem;">
                    <div class="form-group" style="flex: 2; margin-bottom: 0.75rem;">
                        <label class="form-label">Item Name <span class="required">*</span></label>
                        <input type="text" class="form-input item-name" placeholder="e.g., Johnnie Walker Blue Label 1L" value="${initialData?.itemName || ''}">
                    </div>
                    <div class="form-group" style="flex: 1; margin-bottom: 0.75rem;">
                        <label class="form-label">Qty</label>
                        <input type="number" class="form-input item-qty" value="${initialData?.quantity || 1}" min="1" onchange="updateRequestSummary()">
                    </div>
                </div>

                <div class="form-row" style="gap: 0.75rem;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0.75rem;">
                        <label class="form-label">Budget Price</label>
                        <input type="number" class="form-input item-budget" placeholder="Max price" step="0.01" value="${initialData?.budgetPrice || ''}" onchange="updateRequestSummary()">
                    </div>
                    <div class="form-group" style="flex: 1; margin-bottom: 0.75rem;">
                        <label class="form-label">Category</label>
                        <select class="form-select item-category">
                            <option value="">Select...</option>
                            <option value="spirits" ${initialData?.category === 'spirits' ? 'selected' : ''}>ü•É Spirits</option>
                            <option value="perfume" ${initialData?.category === 'perfume' ? 'selected' : ''}>‚ú® Perfume</option>
                            <option value="electronics" ${initialData?.category === 'electronics' ? 'selected' : ''}>üì± Electronics</option>
                            <option value="fashion" ${initialData?.category === 'fashion' ? 'selected' : ''}>üëó Fashion</option>
                            <option value="tobacco" ${initialData?.category === 'tobacco' ? 'selected' : ''}>üö¨ Tobacco</option>
                            <option value="other" ${initialData?.category === 'other' ? 'selected' : ''}>üì¶ Other</option>
                        </select>
                    </div>
                </div>

                <!-- Outside Duty-Free Fields -->
                <div class="outside-df-fields" style="display: ${isOutside ? 'block' : 'none'};">
                    <div class="form-row" style="gap: 0.75rem;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0.75rem;">
                            <label class="form-label">Store / Brand</label>
                            <input type="text" class="form-input item-store" placeholder="e.g., Zara, Amazon" value="${initialData?.storeName || ''}">
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0.75rem;">
                            <label class="form-label">Buy Region</label>
                            <input type="text" class="form-input item-region" placeholder="e.g., Germany" value="${initialData?.buyRegion || ''}">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0.75rem;">
                        <label class="form-label">Product URL (optional)</label>
                        <input type="url" class="form-input item-url" placeholder="https://..." value="${initialData?.storeUrl || ''}">
                    </div>
                    <div class="form-group" style="margin-bottom: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" class="item-alternatives" ${initialData?.acceptAlternatives ? 'checked' : ''}>
                            <span class="form-label" style="margin: 0;">Accept alternatives if exact item unavailable</span>
                        </label>
                    </div>
                </div>

                <!-- Duty-Free Fields -->
                <div class="duty-free-fields" style="display: ${!isOutside ? 'block' : 'none'};">
                    <div class="form-row" style="gap: 0.75rem;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0.75rem;">
                            <label class="form-label">Preferred Brand</label>
                            <input type="text" class="form-input item-brand" placeholder="e.g., Johnnie Walker" value="${initialData?.preferredBrand || ''}">
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0.75rem;">
                            <label class="form-label">Duty-Free Store</label>
                            <input type="text" class="form-input item-df-store" placeholder="e.g., Heinemann" value="${initialData?.dutyFreeStore || ''}">
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Specs / Notes</label>
                    <input type="text" class="form-input item-notes" placeholder="Size, color, model, etc." value="${initialData?.notes || ''}">
                </div>
            </div>
        `;

        document.getElementById('requestItemsList').insertAdjacentHTML('beforeend', itemHtml);
        updateRequestSummary();
    }

    function removeRequestItem(itemId) {
        const item = document.getElementById(itemId);
        if (item) {
            item.remove();
            updateRequestSummary();
        }
    }

    function toggleItemFields(itemId) {
        const item = document.getElementById(itemId);
        if (!item) return;

        const source = item.querySelector('.item-source')?.value || getItemSourceForType();
        const isOutside = source === 'OUTSIDE_DUTY_FREE';

        item.querySelector('.outside-df-fields').style.display = isOutside ? 'block' : 'none';
        item.querySelector('.duty-free-fields').style.display = isOutside ? 'none' : 'block';
    }

    function updateRequestSummary() {
        const items = document.querySelectorAll('.request-item');
        let totalQty = 0;
        let totalBudget = 0;
        const currency = document.getElementById('reqCurrency')?.value || 'EUR';
        const currencySymbol = currency === 'PLN' ? 'z≈Ç' : currency === 'USD' ? '$' : currency === 'GBP' ? '¬£' : '‚Ç¨';

        items.forEach(item => {
            const qty = parseInt(item.querySelector('.item-qty')?.value) || 1;
            const budget = parseFloat(item.querySelector('.item-budget')?.value) || 0;
            totalQty += qty;
            totalBudget += budget * qty;
        });

        // Update currency symbol in max price input
        const maxPriceSymbol = document.getElementById('maxPriceCurrencySymbol');
        if (maxPriceSymbol) maxPriceSymbol.textContent = currencySymbol;

        // Get max price
        const maxPrice = parseFloat(document.getElementById('reqMaxPrice')?.value) || 0;

        document.getElementById('summaryTotalItems').textContent = totalQty;
        document.getElementById('summaryTotalBudget').textContent = `${currencySymbol}${totalBudget.toFixed(2)}`;
        document.getElementById('summaryMaxPrice').textContent = `${currencySymbol}${maxPrice.toFixed(2)}`;

        // Show hint if max price is less than item budgets
        const hintEl = document.getElementById('maxPriceHint');
        if (hintEl && maxPrice > 0 && totalBudget > 0) {
            if (maxPrice < totalBudget) {
                hintEl.style.display = 'block';
                hintEl.innerHTML = `‚ö†Ô∏è Your max budget (${currencySymbol}${maxPrice.toFixed(2)}) is less than item budgets (${currencySymbol}${totalBudget.toFixed(2)}). Consider increasing it.`;
                hintEl.style.color = 'var(--accent-red)';
            } else {
                const serviceFeeRoom = maxPrice - totalBudget;
                hintEl.style.display = 'block';
                hintEl.innerHTML = `‚úì This leaves ~${currencySymbol}${serviceFeeRoom.toFixed(2)} for the traveler's service fee`;
                hintEl.style.color = 'var(--accent-gold)';
            }
        } else if (hintEl) {
            hintEl.style.display = 'none';
        }
    }

    function collectRequestItems() {
        const items = [];
        document.querySelectorAll('.request-item').forEach(item => {
            const sourceSelect = item.querySelector('.item-source');
            let itemSource;
            if (currentRequestType === 'BOTH' && sourceSelect) {
                itemSource = sourceSelect.value;
            } else {
                itemSource = getItemSourceForType();
            }

            items.push({
                itemName: item.querySelector('.item-name')?.value?.trim() || '',
                quantity: parseInt(item.querySelector('.item-qty')?.value) || 1,
                budgetPrice: parseFloat(item.querySelector('.item-budget')?.value) || null,
                category: item.querySelector('.item-category')?.value || null,
                itemSource,
                notes: item.querySelector('.item-notes')?.value?.trim() || null,
                preferredBrand: item.querySelector('.item-brand')?.value?.trim() || null,
                storeUrl: item.querySelector('.item-url')?.value?.trim() || null,
                storeName: item.querySelector('.item-store')?.value?.trim() || null,
                buyRegion: item.querySelector('.item-region')?.value?.trim() || null,
                acceptAlternatives: item.querySelector('.item-alternatives')?.checked || false,
                dutyFreeStore: item.querySelector('.item-df-store')?.value?.trim() || null,
            });
        });
        return items;
    }

    async function submitNewRequest() {
        requireAuth(async () => {
            const items = collectRequestItems();

            // Validate
            if (items.length === 0) {
                toast('Please add at least one item', 'error');
                return;
            }

            const fromAirport = document.getElementById('reqFromAirport')?.value?.trim().toUpperCase();
            const toAirport = document.getElementById('reqToAirport')?.value?.trim().toUpperCase();
            const fromCity = document.getElementById('reqFromCity')?.value?.trim();
            const toCity = document.getElementById('reqToCity')?.value?.trim();

            if (!fromAirport || !toAirport) {
                toast('Please enter From and To airports', 'error');
                return;
            }

            // Validate each item has a name
            for (let i = 0; i < items.length; i++) {
                if (!items[i].itemName) {
                    toast(`Item ${i + 1}: Please enter an item name`, 'error');
                    return;
                }
            }

            // Warn if outside duty-free items have no store info
            const outsideItems = items.filter(i => i.itemSource === 'OUTSIDE_DUTY_FREE');
            const noStoreInfo = outsideItems.filter(i => !i.storeUrl && !i.storeName && !i.preferredBrand);
            if (noStoreInfo.length > 0 && outsideItems.length > 0) {
                console.log('Warning: Some outside duty-free items have no store/brand info');
            }

            // Get max price
            const maxPriceValue = document.getElementById('reqMaxPrice')?.value;
            const maxPrice = maxPriceValue ? parseFloat(maxPriceValue) : null;

            // Determine if outside duty-free is allowed based on request type
            const allowOutsideDutyFree = (currentRequestType === 'OUTSIDE_DUTY_FREE' || currentRequestType === 'BOTH');

            const data = {
                requestType: currentRequestType,
                items,
                fromAirport,
                fromCity: fromCity || fromAirport,
                toAirport,
                toCity: toCity || toAirport,
                neededBy: document.getElementById('reqNeededBy')?.value || null,
                currency: document.getElementById('reqCurrency')?.value || 'EUR',
                generalNotes: document.getElementById('reqGeneralNotes')?.value?.trim() || null,
                maxPrice: maxPrice && maxPrice > 0 ? maxPrice : null,
                // Outside duty-free preferences
                // "Have a shopper at the end of the world for your purchases"
                allowOutsideDutyFree: allowOutsideDutyFree,
                storeTypePreference: allowOutsideDutyFree ? (document.getElementById('reqStoreType')?.value || 'any') : null,
                itemFlexibility: allowOutsideDutyFree ? (document.getElementById('reqItemFlexibility')?.value || 'exact_item') : null,
            };

            try {
                const response = await fetch('/.netlify/functions/requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (result.success) {
                    hideModal('createRequest');
                    toast('Request created!');
                    resetRequestForm();
                    showPage('my-requests');
                    updateUI();
                } else {
                    toast(result.error || 'Failed to create request', 'error');
                }
            } catch (e) {
                console.error('Error creating request:', e);
                toast('Error creating request', 'error');
            }
        });
    }

    function resetRequestForm() {
        currentRequestType = 'DUTY_FREE';
        requestItems = [];
        requestItemCounter = 0;

        // Reset type selection
        selectRequestType('DUTY_FREE');

        // Clear inputs
        document.getElementById('reqFromAirport').value = '';
        document.getElementById('reqFromCity').value = '';
        document.getElementById('reqToAirport').value = '';
        document.getElementById('reqToCity').value = '';
        document.getElementById('reqNeededBy').value = '';
        document.getElementById('reqCurrency').value = 'EUR';
        document.getElementById('reqGeneralNotes').value = '';

        // Reset max price
        const maxPriceInput = document.getElementById('reqMaxPrice');
        if (maxPriceInput) maxPriceInput.value = '';

        // Reset summary displays
        const summaryMaxPrice = document.getElementById('summaryMaxPrice');
        if (summaryMaxPrice) summaryMaxPrice.textContent = '‚Ç¨0.00';
        const maxPriceHint = document.getElementById('maxPriceHint');
        if (maxPriceHint) maxPriceHint.style.display = 'none';

        // Clear items list and add one empty item
        document.getElementById('requestItemsList').innerHTML = '';
        addRequestItem();
    }

    // Initialize request form when modal opens
    function initRequestForm() {
        resetRequestForm();
    }

    // Override showModal to initialize form
    const originalShowModal = window.showModal;
    window.showModal = function(modalId) {
        if (modalId === 'createRequest') {
            initRequestForm();
        }
        if (modalId === 'createTrip') {
            initTripForm();
        }
        if (originalShowModal) {
            originalShowModal(modalId);
        } else {
            document.getElementById('modal-' + modalId).style.display = 'flex';
        }
    };
    
    function initTripForm() {
        // Set minimum dates to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('tripDeparture').min = today;
        document.getElementById('tripReturn').min = today;
        
        // Add change listener to departure date to update return date minimum
        document.getElementById('tripDeparture').addEventListener('change', function() {
            const departureDate = this.value;
            if (departureDate) {
                document.getElementById('tripReturn').min = departureDate;
            }
        });
    }

    // Legacy function for backward compatibility
    function updateServiceFeeHint() {
        // No longer used - kept for compatibility
    }

    function submitRequest() {
        // Redirect to new function
        submitNewRequest();
    }
    
    // Toggle outside duty-free fields visibility
    function toggleOutsideDutyFreeFields() {
        const optIn = document.getElementById('tripOutsideDutyFreeOptIn').checked;
        const fieldsDiv = document.getElementById('outsideDutyFreeFields');
        if (fieldsDiv) {
            fieldsDiv.style.display = optIn ? 'block' : 'none';
        }
    }

    async function submitTrip() {
        requireAuth(async () => {
            const capacity = document.getElementById('tripCapacity').value;
            const outsideDutyFreeOptIn = document.getElementById('tripOutsideDutyFreeOptIn')?.checked || false;

            const data = {
                fromAirport: document.getElementById('tripFromAirport').value.toUpperCase(),
                fromCity: document.getElementById('tripFromCity').value,
                toAirport: document.getElementById('tripToAirport').value.toUpperCase(),
                toCity: document.getElementById('tripToCity').value,
                departureDate: document.getElementById('tripDeparture').value,
                returnDate: document.getElementById('tripReturn').value || null,
                availableKg: capacity ? parseFloat(capacity) : null,
                // Outside duty-free preferences
                outsideDutyFreeOptIn: outsideDutyFreeOptIn
            };

            // Add outside duty-free preferences if opted in
            if (outsideDutyFreeOptIn) {
                const timeBudget = document.getElementById('tripTimeBudget')?.value;
                const maxStops = document.getElementById('tripMaxStops')?.value;
                const constraintsInput = document.getElementById('tripConstraints')?.value;

                // Get selected categories
                const categoryCheckboxes = document.querySelectorAll('input[name="tripCategories"]:checked');
                const categories = Array.from(categoryCheckboxes).map(cb => cb.value);

                // Validate required fields
                if (!timeBudget || parseInt(timeBudget) < 1) {
                    toast('Please enter a valid time budget (1-240 minutes)', 'error');
                    return;
                }

                data.outsideDutyFreeTimeBudget = parseInt(timeBudget);
                data.outsideDutyFreeMaxStops = parseInt(maxStops) || 3;
                data.outsideDutyFreeCategories = categories;
                data.outsideDutyFreeConstraints = constraintsInput || null;
            }

            // Validate required fields
            if (!data.fromAirport || !data.fromCity || !data.toAirport || !data.toCity || !data.departureDate) {
                toast('Please fill in all required fields', 'error');
                return;
            }
            
            // Validate dates
            const departureDate = new Date(data.departureDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (departureDate < today) {
                toast('Departure date cannot be in the past', 'error');
                return;
            }
            
            if (data.returnDate) {
                const returnDate = new Date(data.returnDate);
                if (returnDate < departureDate) {
                    toast('Return date must be after departure date', 'error');
                    return;
                }
            }
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/trips', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.details || result.error || 'Failed to create trip');
                }

                hideModal('createTrip');
                toast('Trip added! üéâ');

                // Reset form
                document.querySelectorAll('#modal-createTrip input').forEach(el => {
                    if (el.type === 'checkbox') {
                        el.checked = false;
                    } else {
                        el.value = '';
                    }
                });
                document.querySelectorAll('#modal-createTrip select').forEach(el => el.selectedIndex = 0);
                clearAirport('from');
                clearAirport('to');
                toggleOutsideDutyFreeFields(); // Hide the fields

                showPage('my-trips');
                loadMyTrips();
            } catch(e) {
                toast(e.message, 'error');
            }
        });
    }

    async function loadMyTrips() {
        const container = document.getElementById('myTripsList');
        if (!container) return;

        if (!currentUser) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîí</div><div class="empty-state-title">Please log in</div><button class="btn btn-primary" onclick="showModal(\'auth\')">Log In</button></div>';
            return;
        }

        try {
            const response = await fetch('/.netlify/functions/trips?userId=' + currentUser.id, {
                credentials: 'include'
            });
            const data = await response.json();

            if (data.trips && data.trips.length > 0) {
                container.innerHTML = data.trips.map(trip => `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin-bottom: 0.5rem;">${trip.fromCity} ‚Üí ${trip.toCity}</h4>
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">
                                    ${trip.fromAirport} ‚Üí ${trip.toAirport} ‚Ä¢ ${formatDate(trip.departureDate)}${trip.returnDate ? ' - ' + formatDate(trip.returnDate) : ''}
                                </p>
                            </div>
                            <span class="badge badge-${trip.status === 'upcoming' ? 'success' : 'secondary'}">${trip.status}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úàÔ∏è</div><div class="empty-state-title">No trips yet</div><p>Add your first trip to start earning!</p><button class="btn btn-primary" onclick="showModal(\'createTrip\')">Add Trip</button></div>';
            }
        } catch (e) {
            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Failed to load trips</p>';
        }
    }

    // Helpers
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
    }

    // Email Verification
    function checkEmailVerification() {
        const user = currentUser || FAE?.Auth?.currentUser;
        const banner = document.getElementById('emailVerificationBanner');
        if (!banner) return;

        // Show banner if user exists and email is not verified
        if (user && user.emailVerified === false) {
            // Check if user has dismissed the banner in this session
            if (sessionStorage.getItem('emailBannerDismissed') !== 'true') {
                banner.style.display = 'block';
            }
        } else {
            banner.style.display = 'none';
        }
    }

    async function sendVerificationEmail() {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Sending...';

        try {
            const response = await fetch('/.netlify/functions/email-verification/send', {
                method: 'POST',
                credentials: 'include',
            });

            const data = await response.json();

            if (response.ok) {
                showToast('Verification email sent! Please check your inbox.', 'success');
                // Show dev token in console for testing
                if (data.devToken) {
                    console.log('DEV: Verification token:', data.devToken);
                    console.log('DEV: Verification URL:', window.location.origin + '/verify-email?token=' + data.devToken);
                }
            } else {
                showToast(data.error || 'Failed to send verification email', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    function dismissVerificationBanner() {
        const banner = document.getElementById('emailVerificationBanner');
        if (banner) {
            banner.style.display = 'none';
            sessionStorage.setItem('emailBannerDismissed', 'true');
        }
    }

    // ==========================================
    // NEARBY MAP FUNCTIONALITY
    // ==========================================
    let nearbyMap = null;
    let mapMarkers = [];
    let mapUsers = [];
    let mapCurrentUser = null;
    let mapRadiusKm = 25;
    let mapShowAll = false;

    const MAP_COLORS = {
        TRAVELER: '#3b82f6',
        BUYER: '#22c55e',
        CURRENT: '#ef4444',
        NEARBY: '#f59e0b',
    };

    // Initialize map when page is shown
    function initNearbyMap() {
        if (nearbyMap) return; // Already initialized

        const mapContainer = document.getElementById('nearbyMap');
        if (!mapContainer) return;

        nearbyMap = L.map('nearbyMap').setView([52.2297, 21.0122], 6);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(nearbyMap);

        // Load map data
        loadMapUsers();
    }

    async function loadMapUsers() {
        try {
            const response = await fetch('/.netlify/functions/map-users?radiusKm=' + mapRadiusKm, {
                credentials: 'include'
            });
            const data = await response.json();

            mapUsers = data.users || [];
            mapCurrentUser = data.currentUser;

            updateMapDisplay();
            updateMapUI();

        } catch (error) {
            console.error('Failed to load map users:', error);
        }
    }

    function updateMapDisplay() {
        // Clear existing markers
        mapMarkers.forEach(m => nearbyMap.removeLayer(m));
        mapMarkers = [];

        if (!nearbyMap) return;

        // Calculate nearby users
        let nearbyUsers = [];
        if (mapCurrentUser && mapCurrentUser.latitude && mapCurrentUser.longitude && !mapShowAll) {
            const oppositeRole = mapCurrentUser.isTraveler ? 'BUYER' : 'TRAVELER';
            nearbyUsers = mapUsers.filter(u => {
                if (u.id === mapCurrentUser.id) return false;
                const userRole = u.isTraveler ? 'TRAVELER' : 'BUYER';
                if (userRole !== oppositeRole) return false;
                if (!u.latitude || !u.longitude) return false;
                const dist = haversineDistance(mapCurrentUser.latitude, mapCurrentUser.longitude, u.latitude, u.longitude);
                return dist <= mapRadiusKm;
            }).map(u => ({
                ...u,
                distance: haversineDistance(mapCurrentUser.latitude, mapCurrentUser.longitude, u.latitude, u.longitude)
            })).sort((a, b) => a.distance - b.distance);
        }

        const nearbyIds = new Set(nearbyUsers.map(u => u.id));

        // Add markers
        mapUsers.forEach(user => {
            if (!user.latitude || !user.longitude) return;

            const isCurrentUser = mapCurrentUser && user.id === mapCurrentUser.id;
            const isNearby = nearbyIds.has(user.id);
            const userRole = user.isTraveler ? 'TRAVELER' : 'BUYER';

            let color = userRole === 'TRAVELER' ? MAP_COLORS.TRAVELER : MAP_COLORS.BUYER;
            if (isCurrentUser) color = MAP_COLORS.CURRENT;
            else if (isNearby) color = MAP_COLORS.NEARBY;

            const size = isCurrentUser ? 16 : 12;
            const icon = L.divIcon({
                className: 'map-marker',
                html: `<div style="background:${color};width:${size}px;height:${size}px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>`,
                iconSize: [size + 6, size + 6],
                iconAnchor: [(size + 6) / 2, (size + 6) / 2],
            });

            const marker = L.marker([user.latitude, user.longitude], { icon }).addTo(nearbyMap);

            const roleLabel = userRole === 'TRAVELER' ? 'Traveler' : 'Buyer';
            const distText = user.distance ? `<br><span style="color:#f59e0b;">${user.distance.toFixed(1)} km away</span>` : '';
            marker.bindPopup(`<b>${user.name}</b>${isCurrentUser ? ' (You)' : ''}<br><span style="color:${color};">${roleLabel}</span><br>${user.city || ''} ${user.country || ''}${distText}`);

            mapMarkers.push(marker);
        });

        // Update stats
        document.getElementById('nearbyMatchCount').textContent = nearbyUsers.length;
        document.getElementById('totalUserCount').textContent = mapUsers.length;

        // Update nearby list
        const listContainer = document.getElementById('nearbyUsersList');
        const listTitle = document.getElementById('nearbyListTitle');

        if (mapCurrentUser) {
            listTitle.textContent = mapCurrentUser.isTraveler ? 'Nearby Buyers' : 'Nearby Travelers';
        }

        if (nearbyUsers.length > 0 && !mapShowAll) {
            listContainer.innerHTML = nearbyUsers.map(u => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:var(--bg-secondary);border-radius:8px;margin-bottom:0.5rem;cursor:pointer;" onclick="nearbyMap.setView([${u.latitude},${u.longitude}],14)">
                    <div>
                        <div style="font-weight:500;font-size:0.875rem;">${u.name}</div>
                        <div style="font-size:0.75rem;color:var(--text-muted);">${u.city || ''} ${u.country || ''}</div>
                    </div>
                    <span style="background:rgba(245,158,11,0.2);color:#f59e0b;font-size:0.75rem;font-weight:600;padding:0.25rem 0.5rem;border-radius:999px;">${u.distance.toFixed(1)} km</span>
                </div>
            `).join('');
        } else if (mapShowAll) {
            listContainer.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--text-muted);font-size:0.875rem;">Showing all users on map</div>';
        } else {
            listContainer.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--text-muted);font-size:0.875rem;">No nearby matches found</div>';
        }

        // Center on current user
        if (mapCurrentUser && mapCurrentUser.latitude && mapCurrentUser.longitude) {
            nearbyMap.setView([mapCurrentUser.latitude, mapCurrentUser.longitude], 10);
        }
    }

    function updateMapUI() {
        // Update button states based on login
        const geocodeBtn = document.getElementById('geocodeAddressBtn');
        const browserBtn = document.getElementById('useBrowserLocationBtn');

        if (!mapCurrentUser) {
            if (geocodeBtn) geocodeBtn.disabled = true;
            if (browserBtn) browserBtn.disabled = true;
        }
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function updateMapRadius() {
        mapRadiusKm = parseInt(document.getElementById('mapRadiusSelect').value, 10);
        updateMapDisplay();
    }

    function toggleShowAll() {
        mapShowAll = document.getElementById('showAllUsers').checked;
        document.getElementById('mapRadiusSelect').disabled = mapShowAll;
        updateMapDisplay();
    }

    async function geocodeMyAddress() {
        const btn = document.getElementById('geocodeAddressBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Geocoding...';

        try {
            const response = await fetch('/.netlify/functions/update-location', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ geocodeAddress: true })
            });
            const data = await response.json();

            if (response.ok) {
                showToast('Location updated from your address!', 'success');
                await loadMapUsers();
            } else {
                showToast(data.error || 'Failed to geocode address', 'error');
            }
        } catch (e) {
            showToast('Failed to update location', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'üìç Update from Address';
        }
    }

    async function useBrowserLocation() {
        if (!navigator.geolocation) {
            showToast('Geolocation not supported by your browser', 'error');
            return;
        }

        const btn = document.getElementById('useBrowserLocationBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Getting location...';

        navigator.geolocation.getCurrentPosition(
            async (position) => {
                try {
                    const response = await fetch('/.netlify/functions/update-location', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            fromBrowser: true
                        })
                    });
                    const data = await response.json();

                    if (response.ok) {
                        showToast('Location updated!', 'success');
                        await loadMapUsers();
                    } else {
                        showToast(data.error || 'Failed to update location', 'error');
                    }
                } catch (e) {
                    showToast('Failed to update location', 'error');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'üåê Use My Location';
                }
            },
            (error) => {
                showToast('Could not get your location: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'üåê Use My Location';
            },
            { enableHighAccuracy: true }
        );
    }

    // Initialize map when switching to that page
    const originalShowPage = showPage;
    showPage = function(pageName) {
        originalShowPage(pageName);
        if (pageName === 'nearby-map') {
            setTimeout(initNearbyMap, 100);
        }
    };
    </script>
    <script src="leaflet.min.js"></script>

    <!-- Welcome Panel Logic -->
    <script>
    (function() {
        function checkWelcomePanel() {
            var tripCount = parseInt(document.getElementById('statTrips')?.textContent) || 0;
            var dealCount = parseInt(document.getElementById('statDeals')?.textContent) || 0;
            var panel = document.getElementById('welcomePanel');
            if (panel && tripCount === 0 && dealCount === 0) {
                panel.style.display = 'block';
            } else if (panel) {
                panel.style.display = 'none';
            }
        }
        // Check after a delay to let data load
        setTimeout(checkWelcomePanel, 1500);
        // Also observe stat changes
        var observer = new MutationObserver(function() { setTimeout(checkWelcomePanel, 100); });
        var trips = document.getElementById('statTrips');
        var deals = document.getElementById('statDeals');
        if (trips) observer.observe(trips, { childList: true, characterData: true, subtree: true });
        if (deals) observer.observe(deals, { childList: true, characterData: true, subtree: true });
    })();
    // Handle #add-trip deep link
    if (window.location.hash === '#add-trip') {
        setTimeout(function() { if (typeof showModal === 'function') showModal('createTrip'); }, 500);
    }
    </script>

    <!-- Back to Top Button -->
    <button class="back-to-top" aria-label="Back to top">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4l-8 8h5v8h6v-8h5z"/></svg>
    </button>
    <script>
        (function() {
            const btn = document.querySelector('.back-to-top');
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const SCROLL_THRESHOLD = 300;

            function updateVisibility() {
                if (window.scrollY > SCROLL_THRESHOLD) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
            }

            window.addEventListener('scroll', updateVisibility, { passive: true });
            updateVisibility();

            btn.addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: prefersReducedMotion ? 'auto' : 'smooth' });
            });
        })();
    </script>
</body>
</html>
